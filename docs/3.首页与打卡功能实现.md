# 3. 首页与打卡功能实现

## 📋 概述

本文档说明首页和打卡功能的实现细节，包括首页状态展示、打卡倒计时、打卡提交等功能。

## 🎯 功能清单

### 1. 首页功能 (`/home`)

#### 1.1 顶部 Banner 卡片
- **WeighIn 标语**："坚持每周，遇见更好的自己"
- **视觉设计**：渐变背景，奖杯图标装饰

#### 1.2 核心状态卡片
根据打卡状态显示不同的内容：

**状态 A - 未打卡**：
- 显示翻页倒计时（距离截止时间）
- "立即打卡" 按钮，跳转到打卡页面

**状态 B - 已打卡**：
- 显示打卡成功提示
- 显示本周体重
- "查看记录" 按钮，跳转到个人页面

**状态 C - 已关闭**：
- 显示距离下次打卡开始的天数
- "查看本周排行榜" 按钮

#### 1.3 倒计时功能
- **翻页倒计时组件** (`components/FlipCountdown.tsx`)
- 实时更新（每秒刷新）
- 显示格式：HH:MM（小时:分钟）

#### 1.4 快捷入口
- **名人堂**：跳转到排行榜页面
- **体重趋势**：跳转到个人页面的体重趋势标签
- **荣誉墙**：跳转到个人页面的荣誉墙标签

### 2. 打卡功能

#### 2.1 打卡页面 (`/checkin`)
- **打卡时间提示**：显示打卡规则（每周一 00:00 - 20:00）
- **体重输入**：
  - 支持小数输入
  - 显示 kg 单位
  - 验证范围（30-200 kg）
- **照片上传**：
  - 支持拍照上传（移动端）
  - 支持相册选择（桌面端和移动端）
  - 图片预览功能
  - 支持删除已选图片
  - 文件大小限制：10MB
- **上周体重对比**：
  - 非首次打卡时显示上周体重
  - 计算并显示预计变化（增重/减重）
- **提交打卡**：验证后提交到服务器

#### 2.2 打卡 API (`/api/checkin`)
- **时间验证**：检查是否在打卡时间段内（每周一 00:00 - 20:00）
- **体重验证**：验证体重范围（30-200 kg）
- **照片验证**：
  - 验证文件类型（仅图片）
  - 验证文件大小（最大 10MB）
- **周数计算**：自动计算当前周数（YYYYWW 格式）
- **照片上传**：上传到阿里云 OSS
- **数据保存**：
  - 如果本周已打卡，则更新记录
  - 如果未打卡，则创建新记录

#### 2.3 打卡状态 API (`/api/checkin/status`)
- 获取当前打卡状态
- 返回本周是否已打卡
- 返回打卡时间是否开启

### 3. 工具函数 (`lib/week.ts`)

提供周数计算和时间判断的工具函数：

- `getWeekNumber(date?)` - 计算周数（YYYYWW 格式）
- `getMonday(date?)` - 获取本周一（00:00:00）
- `getCheckInDeadline(date?)` - 获取打卡截止时间（周一 20:00:00）
- `getNextCheckInStart(date?)` - 获取下次打卡开始时间（下周一 00:00:00）
- `isCheckInOpen(date?)` - 判断打卡是否开启
- `getTimeUntilDeadline(date?)` - 计算距离截止的剩余时间（毫秒）
- `getDaysUntilNextCheckIn(date?)` - 计算距离下次打卡开始的天数

### 4. 历史记录增强

#### 4.1 历史记录 API 更新 (`/api/user/checkins`)
- 在历史记录中添加 `photoUrl` 字段
- 日期格式包含年份（YYYY/MM/DD）

#### 4.2 个人页面历史记录显示
- 每条历史记录显示对应的打卡照片缩略图（64x64px）
- 周数显示格式：`YYYY年第WW周`（如：2026年第2周）

## 📁 文件结构

```
app/
├── home/
│   └── page.tsx              # 首页（状态展示、倒计时）
├── checkin/
│   └── page.tsx              # 打卡页面（体重输入、照片上传）
└── api/
    └── checkin/
        ├── route.ts          # 提交打卡 API
        └── status/
            └── route.ts      # 打卡状态 API

components/
├── FlipCountdown.tsx          # 翻页倒计时组件
└── Loading.tsx               # 加载状态组件

lib/
├── week.ts                    # 周数计算工具函数
├── api-headers.ts            # API 请求头工具（包含模拟时间支持）
└── time-mock.ts              # 时间模拟工具（用于测试）
```

## 🔧 技术实现

### 1. 周数计算逻辑

周数格式：`YYYYWW`（如 `202602` 表示 2026 年第 2 周）

计算方式：
```typescript
const year = date.getFullYear()
const startOfYear = new Date(year, 0, 1)
const days = Math.floor((date.getTime() - startOfYear.getTime()) / (24 * 60 * 60 * 1000))
const weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7)
return year * 100 + weekNumber
```

### 2. 打卡时间规则

- **打卡开始**：每周一 00:00:00
- **打卡截止**：每周一 20:00:00
- **打卡关闭**：周一 20:00:00 之后到周日 23:59:59

### 3. 照片存储

- **存储位置**：阿里云 OSS
- **Bucket**：`weighin-media`
- **目录**：`checkins/`
- **文件命名**：`{userId}-{weekNumber}-{timestamp}.{ext}`
- **URL 保存**：数据库 `checkins.photo_url` 字段

### 4. 状态管理

使用 Zustand 进行状态管理：
- `useAuthStore` - 认证状态（token、用户信息）
- 支持状态持久化（localStorage）
- 支持状态恢复（页面刷新后保持登录）

## 🎨 UI/UX 特性

1. **响应式设计**：适配移动端和桌面端
2. **实时更新**：倒计时每秒刷新
3. **状态反馈**：清晰的视觉状态提示
4. **错误处理**：友好的错误提示信息
5. **加载状态**：统一的加载状态组件

## 📝 注意事项

1. **打卡时间限制**：仅在每周一 00:00 - 20:00 可以打卡
2. **照片要求**：仅支持图片格式，最大 10MB
3. **体重范围**：30-200 kg
4. **周数计算**：基于日历周，不是用户打卡次数
5. **历史记录**：照片 URL 永久保存，可用于历史查看

## 🔄 后续优化建议

1. 添加照片压缩功能，减少上传时间
2. 添加打卡提醒功能
3. 优化倒计时显示（添加秒数）
4. 添加打卡历史筛选功能
5. 添加体重变化趋势预测

