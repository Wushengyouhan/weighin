# WeighIn 数据库设计文档

## 📋 目录
1. [数据库说明](#数据库说明)
2. [表结构设计](#表结构设计)
3. [索引说明](#索引说明)
4. [外键关系](#外键关系)

---

## 🗄️ 数据库说明

### 基本信息
- **数据库类型**：MySQL 8.0+
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci
- **存储引擎**：InnoDB

### 命名规范
- **表名**：小写，多个单词用下划线分隔（snake_case）
- **字段名**：小写，多个单词用下划线分隔（snake_case）
- **主键**：统一使用 `id`，类型为 `BIGINT UNSIGNED`
- **外键**：使用 `表名_id` 格式，如 `user_id`

### ID 字段说明
- 所有表的主键 ID 使用 `BIGINT UNSIGNED AUTO_INCREMENT`
- 支持更大的数值范围（0 到 2^64-1）
- 自动递增，从 1 开始

---

## 📊 表结构设计

### 1. 用户表 (users)

#### 表说明
存储用户的基本信息，包括昵称和头像。用户的其他信息（如登录方式）存储在 `user_auths` 表中。

#### 建表语句
```sql
CREATE TABLE `users` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `nickname` VARCHAR(50) DEFAULT NULL COMMENT '昵称',
  `avatar` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  INDEX `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

#### 字段说明
| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT UNSIGNED | 用户ID，主键，自增 | 是 |
| nickname | VARCHAR(50) | 用户昵称 | 否 |
| avatar | VARCHAR(500) | 头像URL | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间，自动更新 | 是 |

---

### 2. 用户授权表 (user_auths)

#### 表说明
存储用户的登录方式，支持多种登录方式（手机号、微信、GitHub等）。一个用户可以有多个登录方式。

#### 建表语句
```sql
CREATE TABLE `user_auths` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '授权ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID，关联users.id',
  `identity_type` VARCHAR(20) NOT NULL COMMENT '登录类型: phone, wechat, github等',
  `identifier` VARCHAR(64) NOT NULL COMMENT '标识: 手机号、OpenID、UserID等',
  `credential` VARCHAR(255) DEFAULT NULL COMMENT '凭证: 密码Hash（手机登录此项为空）',
  `last_login_at` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_identity` (`identity_type`, `identifier`) COMMENT '确保同一个标识只能绑定一次',
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_last_login_at` (`last_login_at`),
  CONSTRAINT `fk_user_auths_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户授权表';
```

#### 字段说明
| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT UNSIGNED | 授权ID，主键，自增 | 是 |
| user_id | BIGINT UNSIGNED | 用户ID，外键关联users.id | 是 |
| identity_type | VARCHAR(20) | 登录类型：phone（手机号）、wechat（微信）、github等 | 是 |
| identifier | VARCHAR(64) | 标识：手机号、OpenID、UserID等 | 是 |
| credential | VARCHAR(255) | 凭证：密码Hash，手机登录为空 | 否 |
| last_login_at | DATETIME | 最后登录时间 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间，自动更新 | 是 |

#### 业务规则
- `identity_type` 和 `identifier` 组合必须唯一（UNIQUE约束）
- 例如：同一个手机号只能绑定一次
- 一个用户可以有多个登录方式（手机号 + 微信等）

---

### 3. 打卡记录表 (checkins)

#### 表说明
存储用户每周的打卡记录，包括体重、照片和所属周数。每周每个用户只能打卡一次。

#### 建表语句
```sql
CREATE TABLE `checkins` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '打卡ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID，关联users.id',
  `weight` DECIMAL(5, 2) NOT NULL COMMENT '体重（kg），精确到小数点后2位',
  `photo_url` VARCHAR(500) NOT NULL COMMENT '照片URL',
  `week_number` INT UNSIGNED NOT NULL COMMENT '周编号，格式YYYYWW，如202451表示2024年第51周',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_week` (`user_id`, `week_number`) COMMENT '确保每个用户每周只能打卡一次',
  INDEX `idx_week_number` (`week_number`) COMMENT '用于按周查询',
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_created_at` (`created_at`),
  CONSTRAINT `fk_checkins_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='打卡记录表';
```

#### 字段说明
| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT UNSIGNED | 打卡ID，主键，自增 | 是 |
| user_id | BIGINT UNSIGNED | 用户ID，外键关联users.id | 是 |
| weight | DECIMAL(5, 2) | 体重（kg），范围30.00-200.00 | 是 |
| photo_url | VARCHAR(500) | 照片URL | 是 |
| week_number | INT UNSIGNED | 周编号，格式YYYYWW（如202451） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间，自动更新 | 是 |

#### 业务规则
- 每个用户每周只能打卡一次（`user_id` + `week_number` 唯一约束）
- `week_number` 格式：`年份 * 100 + 周数`，如 2024 年第 51 周 = 202451
- 体重范围：30.00 - 200.00 kg

---

### 4. 排名与奖励表 (rewards)

#### 表说明
存储每周的排名结果和奖励信息，包括减重差值、排名、奖状图片等。每周每个用户只有一条记录。

#### 建表语句
```sql
CREATE TABLE `rewards` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '奖励ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID，关联users.id',
  `week_number` INT UNSIGNED NOT NULL COMMENT '周编号，格式YYYYWW，如202451',
  `weight_diff` DECIMAL(5, 2) NOT NULL COMMENT '减重差值（kg），精确到小数点后2位',
  `rank` INT UNSIGNED NOT NULL COMMENT '排名，1=冠军，2=亚军，3=季军，4+=参与奖',
  `certificate_url` VARCHAR(500) DEFAULT NULL COMMENT '奖状图片URL',
  `type` TINYINT UNSIGNED NOT NULL COMMENT '奖励类型：1=冠军，2=亚军，3=季军，4=参与奖',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_week` (`user_id`, `week_number`) COMMENT '确保每个用户每周只有一条奖励记录',
  INDEX `idx_week_rank` (`week_number`, `rank`) COMMENT '用于按周和排名查询',
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_week_number` (`week_number`),
  CONSTRAINT `fk_rewards_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='排名与奖励表';
```

#### 字段说明
| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT UNSIGNED | 奖励ID，主键，自增 | 是 |
| user_id | BIGINT UNSIGNED | 用户ID，外键关联users.id | 是 |
| week_number | INT UNSIGNED | 周编号，格式YYYYWW | 是 |
| weight_diff | DECIMAL(5, 2) | 减重差值（kg），可为负数（增重） | 是 |
| rank | INT UNSIGNED | 排名，1=冠军，2=亚军，3=季军，4+=参与奖 | 是 |
| certificate_url | VARCHAR(500) | 奖状图片URL | 否 |
| type | TINYINT UNSIGNED | 奖励类型：1=冠军，2=亚军，3=季军，4=参与奖 | 是 |
| created_at | DATETIME | 创建时间 | 是 |

#### 业务规则
- 每个用户每周只有一条奖励记录（`user_id` + `week_number` 唯一约束）
- `type` 字段：1=冠军，2=亚军，3=季军，4=参与奖
- `weight_diff` 可以为负数（表示增重）
- 排名在每周结算时自动计算

---

### 5. 奖状配置表 (cert_configs)

#### 表说明
存储奖状模板配置，包括冠军、亚军、季军、参与奖的底图。可以为特定周设置特殊模板，也可以设置默认模板。

#### 建表语句
```sql
CREATE TABLE `cert_configs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `week_number` INT UNSIGNED DEFAULT NULL COMMENT '周编号，格式YYYYWW。NULL表示默认模板',
  `img_gold` VARCHAR(500) NOT NULL COMMENT '冠军底图URL',
  `img_silver` VARCHAR(500) NOT NULL COMMENT '亚军底图URL',
  `img_bronze` VARCHAR(500) NOT NULL COMMENT '季军底图URL',
  `img_participate` VARCHAR(500) NOT NULL COMMENT '参与奖底图URL',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_week_number` (`week_number`) COMMENT '确保每个周只有一个配置'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='奖状配置表';
```

#### 字段说明
| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT UNSIGNED | 配置ID，主键，自增 | 是 |
| week_number | INT UNSIGNED | 周编号，NULL表示默认模板 | 否 |
| img_gold | VARCHAR(500) | 冠军底图URL | 是 |
| img_silver | VARCHAR(500) | 亚军底图URL | 是 |
| img_bronze | VARCHAR(500) | 季军底图URL | 是 |
| img_participate | VARCHAR(500) | 参与奖底图URL | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间，自动更新 | 是 |

#### 业务规则
- `week_number` 为 NULL 时，表示默认模板
- `week_number` 不为 NULL 时，表示该周的特殊模板
- 每个周只能有一个配置（`week_number` 唯一约束）
- 生成奖状时，优先使用该周的特殊模板，如果没有则使用默认模板

---

### 6. 验证码表 (verification_codes)

#### 表说明
存储短信验证码，用于手机号登录。验证码有效期5分钟，使用后标记为已使用。

#### 建表语句
```sql
CREATE TABLE `verification_codes` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '验证码ID',
  `phone` VARCHAR(20) NOT NULL COMMENT '手机号',
  `code` VARCHAR(6) NOT NULL COMMENT '6位验证码',
  `expires_at` DATETIME NOT NULL COMMENT '过期时间（5分钟后）',
  `used` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否已使用：0=未使用，1=已使用',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  INDEX `idx_phone_expires` (`phone`, `expires_at`) COMMENT '用于查询有效验证码',
  INDEX `idx_expires_at` (`expires_at`) COMMENT '用于清理过期验证码'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='验证码表';
```

#### 字段说明
| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT UNSIGNED | 验证码ID，主键，自增 | 是 |
| phone | VARCHAR(20) | 手机号 | 是 |
| code | VARCHAR(6) | 6位验证码 | 是 |
| expires_at | DATETIME | 过期时间（创建时间+5分钟） | 是 |
| used | TINYINT(1) | 是否已使用：0=未使用，1=已使用 | 是 |
| created_at | DATETIME | 创建时间 | 是 |

#### 业务规则
- 验证码有效期：5分钟
- 验证码使用后，`used` 字段标记为 1
- 同一个手机号可以有多条验证码记录（用于防刷检查）
- 需要定时任务清理过期验证码（建议每小时清理一次）

---

## 🔍 索引说明

### 主键索引
所有表的主键 `id` 自动创建主键索引。

### 唯一索引
- `user_auths`: `uk_identity` (`identity_type`, `identifier`) - 确保同一标识只能绑定一次
- `checkins`: `uk_user_week` (`user_id`, `week_number`) - 确保每个用户每周只能打卡一次
- `rewards`: `uk_user_week` (`user_id`, `week_number`) - 确保每个用户每周只有一条奖励记录
- `cert_configs`: `uk_week_number` (`week_number`) - 确保每个周只有一个配置

### 普通索引
- `users`: `idx_created_at` - 用于按创建时间查询
- `user_auths`: `idx_user_id` - 用于查询用户的所有登录方式
- `user_auths`: `idx_last_login_at` - 用于查询最近登录的用户
- `checkins`: `idx_week_number` - 用于按周查询打卡记录
- `checkins`: `idx_user_id` - 用于查询用户的所有打卡记录
- `checkins`: `idx_created_at` - 用于按创建时间查询
- `rewards`: `idx_week_rank` (`week_number`, `rank`) - 用于查询某周的前三名
- `rewards`: `idx_user_id` - 用于查询用户的所有奖励记录
- `rewards`: `idx_week_number` - 用于按周查询奖励记录
- `verification_codes`: `idx_phone_expires` (`phone`, `expires_at`) - 用于查询有效验证码
- `verification_codes`: `idx_expires_at` - 用于清理过期验证码

---

## 🔗 外键关系

### 外键约束
- `user_auths.user_id` → `users.id` (ON DELETE CASCADE)
- `checkins.user_id` → `users.id` (ON DELETE CASCADE)
- `rewards.user_id` → `users.id` (ON DELETE CASCADE)

### 级联删除
所有外键都设置了 `ON DELETE CASCADE`，当删除用户时，会自动删除：
- 该用户的所有登录方式（user_auths）
- 该用户的所有打卡记录（checkins）
- 该用户的所有奖励记录（rewards）

---

## 📝 初始化数据

### 创建默认奖状模板
```sql
-- 插入默认奖状模板（week_number 为 NULL）
INSERT INTO `cert_configs` (`week_number`, `img_gold`, `img_silver`, `img_bronze`, `img_participate`)
VALUES (
  NULL,
  'https://example.com/cert/gold-default.jpg',
  'https://example.com/cert/silver-default.jpg',
  'https://example.com/cert/bronze-default.jpg',
  'https://example.com/cert/participate-default.jpg'
);
```

---

## 🔧 维护建议

### 1. 定时清理过期验证码
建议每小时执行一次清理任务：
```sql
-- 删除过期且已使用的验证码
DELETE FROM `verification_codes`
WHERE `expires_at` < NOW() AND `used` = 1;

-- 或者删除所有过期验证码（包括未使用的）
DELETE FROM `verification_codes`
WHERE `expires_at` < NOW();
```

### 2. 数据备份
建议每天备份一次数据库，特别是 `checkins` 和 `rewards` 表。

### 3. 性能优化
- 定期分析表：`ANALYZE TABLE table_name;`
- 定期优化表：`OPTIMIZE TABLE table_name;`
- 监控慢查询日志

---

## 📊 表关系图

```
users (用户表)
  ├── user_auths (用户授权表) - 一对多
  ├── checkins (打卡记录表) - 一对多
  └── rewards (排名与奖励表) - 一对多

cert_configs (奖状配置表) - 独立表
verification_codes (验证码表) - 独立表
```

---

*最后更新：2024年12月*
