# 4. æµ‹è¯•æ–¹æ³•ä¸æµ‹è¯•ä»£ç æ¸…ç†

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä½¿ç”¨æ—¶é—´æ¨¡æ‹Ÿå·¥å…·è¿›è¡Œæµ‹è¯•ï¼Œä»¥åŠå¦‚ä½•æ¸…ç†æµ‹è¯•ç›¸å…³çš„ä»£ç ã€‚

## ğŸ§ª æµ‹è¯•å·¥å…·

### 1. æ—¶é—´æµ‹è¯•é¡µé¢ (`/test-time`)

è®¿é—® `http://localhost:3000/test-time` å¯ä»¥æ‰“å¼€æ—¶é—´æµ‹è¯•å·¥å…·é¡µé¢ã€‚

#### åŠŸèƒ½è¯´æ˜

1. **æ‰‹åŠ¨è®¾ç½®æ¨¡æ‹Ÿæ—¶é—´**
   - å¯ä»¥è®¾ç½®å¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†
   - ç‚¹å‡»"åº”ç”¨æ¨¡æ‹Ÿæ—¶é—´"æŒ‰é’®åº”ç”¨è®¾ç½®
   - ç‚¹å‡»"æ¢å¤çœŸå®æ—¶é—´"æŒ‰é’®æ¸…é™¤æ¨¡æ‹Ÿæ—¶é—´

2. **å¿«é€Ÿæµ‹è¯•åœºæ™¯**
   - **å‘¨ä¸€ 10:00ï¼ˆæ‰“å¡ä¸­ï¼‰**ï¼šæµ‹è¯•æ‰“å¡å¼€æ”¾çŠ¶æ€
   - **å‘¨ä¸€ 19:30ï¼ˆå³å°†æˆªæ­¢ï¼‰**ï¼šæµ‹è¯•æ¥è¿‘æˆªæ­¢æ—¶é—´çš„çŠ¶æ€
   - **å‘¨ä¸€ 20:30ï¼ˆå·²å…³é—­ï¼‰**ï¼šæµ‹è¯•æ‰“å¡å…³é—­çŠ¶æ€
   - **å‘¨äºŒ 10:00ï¼ˆå·²å…³é—­ï¼‰**ï¼šæµ‹è¯•éæ‰“å¡æ—¥çŠ¶æ€
   - **å‘¨æ—¥ 10:00ï¼ˆå·²å…³é—­ï¼‰**ï¼šæµ‹è¯•å‘¨æœ«çŠ¶æ€

3. **å®æ—¶çŠ¶æ€æ˜¾ç¤º**
   - å½“å‰æ—¶é—´
   - å‘¨æ•°
   - æœ¬å‘¨ä¸€æ—¥æœŸ
   - æ‰“å¡æˆªæ­¢æ—¶é—´
   - ä¸‹æ¬¡æ‰“å¡å¼€å§‹æ—¶é—´
   - æ‰“å¡çŠ¶æ€ï¼ˆå¼€æ”¾/å…³é—­ï¼‰
   - å‰©ä½™æ—¶é—´æˆ–è·ç¦»ä¸‹æ¬¡æ‰“å¡å¤©æ•°

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### æ­¥éª¤ 1ï¼šè®¾ç½®æ¨¡æ‹Ÿæ—¶é—´

1. æ‰“å¼€æµ‹è¯•é¡µé¢ `/test-time`
2. è®¾ç½®æƒ³è¦æµ‹è¯•çš„æ—¶é—´ï¼ˆæˆ–ç‚¹å‡»å¿«é€Ÿæµ‹è¯•æŒ‰é’®ï¼‰
3. ç‚¹å‡»"åº”ç”¨æ¨¡æ‹Ÿæ—¶é—´"

### æ­¥éª¤ 2ï¼šæµ‹è¯•åŠŸèƒ½

è®¾ç½®æ¨¡æ‹Ÿæ—¶é—´åï¼Œå¯ä»¥ï¼š

1. **æµ‹è¯•é¦–é¡µ** (`/home`)
   - æŸ¥çœ‹ä¸åŒæ—¶é—´ä¸‹çš„çŠ¶æ€æ˜¾ç¤º
   - æŸ¥çœ‹å€’è®¡æ—¶æ˜¯å¦æ­£ç¡®
   - æµ‹è¯•å„ç§çŠ¶æ€ä¸‹çš„æŒ‰é’®åŠŸèƒ½

2. **æµ‹è¯•æ‰“å¡é¡µé¢** (`/checkin`)
   - æµ‹è¯•æ‰“å¡æ—¶é—´éªŒè¯
   - æµ‹è¯•ä¸åŒæ—¶é—´ä¸‹çš„é¡µé¢æ˜¾ç¤º

3. **æµ‹è¯• API**
   - API ä¼šè‡ªåŠ¨ä½¿ç”¨æ¨¡æ‹Ÿæ—¶é—´è¿›è¡ŒéªŒè¯
   - æµ‹è¯•æ‰“å¡æäº¤çš„æ—¶é—´é™åˆ¶

### æ­¥éª¤ 3ï¼šæ¢å¤çœŸå®æ—¶é—´

æµ‹è¯•å®Œæˆåï¼Œç‚¹å‡»"æ¢å¤çœŸå®æ—¶é—´"æŒ‰é’®ï¼Œæˆ–åˆ·æ–°é¡µé¢åæ¸…é™¤ localStorageã€‚

## ğŸ—‘ï¸ æµ‹è¯•ä»£ç æ¸…ç†

### 1. æµ‹è¯•é¡µé¢æ¸…ç†

**æ–‡ä»¶**ï¼š`app/test-time/page.tsx`

**æ“ä½œ**ï¼šåˆ é™¤æ•´ä¸ªæ–‡ä»¶

```bash
rm app/test-time/page.tsx
```

### 2. æ—¶é—´æ¨¡æ‹Ÿå·¥å…·æ¸…ç†

#### 2.1 å®¢æˆ·ç«¯æ—¶é—´æ¨¡æ‹Ÿå·¥å…·

**æ–‡ä»¶**ï¼š`lib/time-mock.ts`

**æ“ä½œ**ï¼šåˆ é™¤æ•´ä¸ªæ–‡ä»¶

```bash
rm lib/time-mock.ts
```

#### 2.2 æœåŠ¡ç«¯æ—¶é—´æ¨¡æ‹Ÿå·¥å…·

**æ–‡ä»¶**ï¼š`lib/time-mock-server.ts`

**æ“ä½œ**ï¼šåˆ é™¤æ•´ä¸ªæ–‡ä»¶

```bash
rm lib/time-mock-server.ts
```

### 3. ä»£ç å¼•ç”¨æ¸…ç†

#### 3.1 æ›´æ–° `lib/week.ts`

**éœ€è¦ä¿®æ”¹**ï¼šç§»é™¤å¯¹ `time-mock` çš„å¼•ç”¨

```typescript
// åˆ é™¤è¿™è¡Œ
import { getCurrentDate } from './time-mock'

// å°†æ‰€æœ‰å‡½æ•°å‚æ•°æ”¹å›é»˜è®¤å€¼
export function getWeekNumber(date: Date = new Date()): number {
  // ...
}

export function getMonday(date: Date = new Date()): Date {
  // ...
}

// ... å…¶ä»–å‡½æ•°ç±»ä¼¼
```

#### 3.2 æ›´æ–° `lib/api-headers.ts`

**æ–‡ä»¶**ï¼š`lib/api-headers.ts`

**éœ€è¦ä¿®æ”¹**ï¼šç§»é™¤æ¨¡æ‹Ÿæ—¶é—´ç›¸å…³ä»£ç 

```typescript
/**
 * API è¯·æ±‚å¤´å·¥å…·å‡½æ•°
 * ç»Ÿä¸€å¤„ç†è®¤è¯è¯·æ±‚å¤´
 */

/**
 * åˆ›å»º API è¯·æ±‚å¤´
 * @param token è®¤è¯ token
 */
export function createApiHeaders(token: string | null): HeadersInit {
  const headers: HeadersInit = {}
  
  if (token) {
    headers['Authorization'] = `Bearer ${token}`
  }

  // åˆ é™¤æ¨¡æ‹Ÿæ—¶é—´ç›¸å…³ä»£ç 
  // const mockDateHeader = getMockDateHeader()
  // if (mockDateHeader) {
  //   headers['x-mock-date'] = mockDateHeader
  // }

  return headers
}
```

#### 3.3 æ›´æ–° API è·¯ç”±

**æ–‡ä»¶**ï¼š`app/api/checkin/status/route.ts`

**éœ€è¦ä¿®æ”¹**ï¼šç§»é™¤æ¨¡æ‹Ÿæ—¶é—´ç›¸å…³ä»£ç 

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { db } from '@/lib/db'
import { getUserIdFromRequest } from '@/lib/auth'
import { getWeekNumber, isCheckInOpen } from '@/lib/week'
// åˆ é™¤è¿™è¡Œ
// import { getCurrentDate } from '@/lib/time-mock-server'

export async function GET(request: NextRequest) {
  // ...
  
  // åˆ é™¤è¿™ä¸¤è¡Œ
  // const mockDate = getCurrentDate(request.headers)
  // const currentWeekNumber = getWeekNumber(mockDate)
  // const checkInOpen = isCheckInOpen(mockDate)
  
  // æ”¹å›åŸæ¥çš„ä»£ç 
  const currentWeekNumber = getWeekNumber()
  const checkInOpen = isCheckInOpen()
  
  // ...
}
```

**æ–‡ä»¶**ï¼š`app/api/checkin/route.ts`

**éœ€è¦ä¿®æ”¹**ï¼šç§»é™¤æ¨¡æ‹Ÿæ—¶é—´ç›¸å…³ä»£ç 

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { db } from '@/lib/db'
import { getUserIdFromRequest } from '@/lib/auth'
import { getWeekNumber, isCheckInOpen } from '@/lib/week'
// åˆ é™¤è¿™è¡Œ
// import { getCurrentDate } from '@/lib/time-mock-server'
import OSS from 'ali-oss'

// ...

export async function POST(request: NextRequest) {
  // ...
  
  // åˆ é™¤è¿™ä¸¤è¡Œ
  // const mockDate = getCurrentDate(request.headers)
  // if (!isCheckInOpen(mockDate)) {
  
  // æ”¹å›åŸæ¥çš„ä»£ç 
  if (!isCheckInOpen()) {
    // ...
  }
  
  // ...
  
  // åˆ é™¤è¿™è¡Œ
  // const weekNumber = getWeekNumber(mockDate)
  
  // æ”¹å›åŸæ¥çš„ä»£ç 
  const weekNumber = getWeekNumber()
  
  // ...
}
```

## ğŸ“ æ¸…ç†æ£€æŸ¥æ¸…å•

æ¸…ç†å®Œæˆåï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

- [ ] åˆ é™¤ `app/test-time/page.tsx`
- [ ] åˆ é™¤ `lib/time-mock.ts`
- [ ] åˆ é™¤ `lib/time-mock-server.ts`
- [ ] æ›´æ–° `lib/week.ts`ï¼Œç§»é™¤ `time-mock` å¼•ç”¨
- [ ] æ›´æ–° `lib/api-headers.ts`ï¼Œç§»é™¤æ¨¡æ‹Ÿæ—¶é—´ä»£ç 
- [ ] æ›´æ–° `app/api/checkin/status/route.ts`ï¼Œç§»é™¤æ¨¡æ‹Ÿæ—¶é—´ä»£ç 
- [ ] æ›´æ–° `app/api/checkin/route.ts`ï¼Œç§»é™¤æ¨¡æ‹Ÿæ—¶é—´ä»£ç 
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ–‡ä»¶å¼•ç”¨äº†æµ‹è¯•ç›¸å…³ä»£ç 
- [ ] è¿è¡Œé¡¹ç›®ï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¸…ç†å‰å¤‡ä»½**ï¼šå»ºè®®åœ¨æ¸…ç†å‰åˆ›å»ºä»£ç å¤‡ä»½æˆ–æäº¤åˆ° Git
2. **é€æ­¥æ¸…ç†**ï¼šå¯ä»¥é€æ­¥æ¸…ç†ï¼Œæ¯æ­¥éƒ½æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
3. **ä¿ç•™æ–‡æ¡£**ï¼šæµ‹è¯•æ–‡æ¡£å¯ä»¥ä¿ç•™ï¼Œæ–¹ä¾¿åç»­å‚è€ƒ
4. **ç”Ÿäº§ç¯å¢ƒ**ï¼šç¡®ä¿ç”Ÿäº§ç¯å¢ƒä¸åŒ…å«æµ‹è¯•ä»£ç 

## ğŸ” æŸ¥æ‰¾æµ‹è¯•ä»£ç å¼•ç”¨

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥æ‰¾æ‰€æœ‰æµ‹è¯•ä»£ç çš„å¼•ç”¨ï¼š

```bash
# æŸ¥æ‰¾ time-mock çš„å¼•ç”¨
grep -r "time-mock" app/ lib/

# æŸ¥æ‰¾ time-mock-server çš„å¼•ç”¨
grep -r "time-mock-server" app/ lib/

# æŸ¥æ‰¾ test-time çš„å¼•ç”¨
grep -r "test-time" app/

# æŸ¥æ‰¾ x-mock-date çš„å¼•ç”¨
grep -r "x-mock-date" app/ lib/
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [3. é¦–é¡µä¸æ‰“å¡åŠŸèƒ½å®ç°.md](./3.é¦–é¡µä¸æ‰“å¡åŠŸèƒ½å®ç°.md) - åŠŸèƒ½å®ç°è¯´æ˜
- [2. ä¸ªäººé¡µé¢ä¸å¤´åƒä¸Šä¼ å®ç°.md](./2.ä¸ªäººé¡µé¢ä¸å¤´åƒä¸Šä¼ å®ç°.md) - ä¸ªäººé¡µé¢åŠŸèƒ½è¯´æ˜

