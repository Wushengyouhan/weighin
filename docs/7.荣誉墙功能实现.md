# 7. 荣誉墙功能实现

## 📋 概述

本文档说明荣誉墙功能的实现细节，包括奖状展示、统计信息、保存功能等。

## 🎯 功能清单

### 1. 页面位置

荣誉墙位于个人中心页面（`/profile`）的"荣誉墙"标签页中，与"体重趋势"标签页并列显示。

### 2. 主要功能

#### 2.1 奖状展示

- **展示方式**：网格布局（2列），展示用户获得的所有奖状
- **排序规则**：按结算时间倒序排列（最新的在前）
- **卡片样式**：
  - 方形卡片（`aspect-square`）
  - 圆角边框
  - 悬停时显示阴影效果

#### 2.2 奖状内容

每个奖状卡片包含两部分：

**图片区域**：
- 如果有 `certificate_url`，显示奖状底图（完整显示，`object-contain`）
- 如果没有 `certificate_url`，显示渐变背景和图标占位符
- 图片区域为方形，背景色为浅灰色（`bg-gray-100`）

**信息区域**：
- 显示周标题（如"2026年第2周冠军"）
- 显示该周周一的日期（如"2026/01/05"）
- 紧凑的间距设计（`px-3 py-1.5`）

#### 2.3 交互功能

**悬停效果**：
- 鼠标悬停时，图片区域显示半透明黑色遮罩（`bg-black/60`）
- 显示"保存"按钮，点击可保存奖状到相册

**点击效果**：
- 卡片整体可点击
- 悬停时显示阴影效果（`hover:shadow-lg`）

#### 2.4 统计信息

在荣誉墙标签页顶部显示统计卡片：

- **冠军数量**：获得第1名的次数
- **亚军数量**：获得第2名的次数
- **季军数量**：获得第3名的次数
- **参与奖数量**：获得第4名及以后的次数

统计卡片使用不同颜色的渐变背景：
- 冠军：金色渐变（`from-yellow-400 to-yellow-600`）
- 亚军：灰色渐变（`from-gray-300 to-gray-500`）
- 季军：橙色渐变（`from-orange-400 to-orange-600`）
- 参与奖：蓝色渐变（`from-blue-400 to-blue-600`）

### 3. API 接口

#### 3.1 获取荣誉墙数据

**路径**：`GET /api/user/rewards`

**请求头**：
```
Authorization: Bearer {token}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "stats": {
      "champion": 3,
      "runnerUp": 2,
      "third": 1,
      "participant": 5
    },
    "certificates": [
      {
        "id": "1",
        "type": "champion",
        "title": "2026年第2周冠军",
        "date": "2026/01/05",
        "color": "from-yellow-400 to-yellow-600",
        "certificateUrl": "https://example.com/cert/gold.jpg",
        "weekNumber": 202602
      }
    ]
  }
}
```

**字段说明**：
- `stats`：统计信息对象
  - `champion`：冠军数量
  - `runnerUp`：亚军数量
  - `third`：季军数量
  - `participant`：参与奖数量
- `certificates`：奖状数组
  - `id`：奖状记录ID
  - `type`：奖励类型（`champion`、`runner-up`、`third`、`participant`）
  - `title`：奖状标题（如"2026年第2周冠军"）
  - `date`：该周周一的日期（格式：YYYY/MM/DD）
  - `color`：占位符背景渐变色
  - `certificateUrl`：奖状底图URL（可能为 `null`）
  - `weekNumber`：周编号（YYYYWW格式）

### 4. 日期显示逻辑

#### 4.1 日期计算

荣誉墙显示的日期是该周周一的日期，通过 `getWeekMonday(weekNumber)` 函数计算：

- **跨年周处理**：如果该周包含1月1日，算作新年第一周
- **日期格式**：显示为 `YYYY/MM/DD` 格式
- **实际日期**：即使该周周一是上一年的日期，也会显示实际日期（如"2025/12/29"）

#### 4.2 示例

- 2026年第1周（包含2025年12月29日-2026年1月4日）→ 显示"2025/12/29"
- 2026年第2周（2026年1月5日-1月11日）→ 显示"2026/01/05"
- 2026年第3周（2026年1月12日-1月18日）→ 显示"2026/01/12"

### 5. 奖状图片显示

#### 5.1 图片来源

奖状图片来自 `certificate_url` 字段，该字段在结算时根据排名自动分配：

- **冠军**（`type = 1`）→ `img_gold`
- **亚军**（`type = 2`）→ `img_silver`
- **季军**（`type = 3`）→ `img_bronze`
- **参与奖**（`type = 4`）→ `img_participate`

#### 5.2 图片显示规则

- **有图片**：显示 `certificate_url` 的图片，使用 `object-contain` 完整显示
- **无图片**：显示渐变背景和图标占位符
- **图片加载失败**：自动回退到占位符显示

#### 5.3 占位符样式

当没有 `certificate_url` 时，显示：
- 渐变背景（根据排名类型不同颜色）
- 奖章图标（🥇、🥈、🥉、🏅）
- "WeighIn" 文字
- "荣誉证书" 文字

### 6. 保存功能

#### 6.1 功能说明

用户可以将奖状保存到相册：

- **触发方式**：鼠标悬停在奖状卡片上，点击"保存"按钮
- **实现方式**：前端调用浏览器下载API（待实现）

#### 6.2 提示信息

在荣誉墙底部显示提示信息：
```
💡 点击奖状可以保存到相册
```

### 7. 空状态处理

#### 7.1 无奖状时

如果用户还没有获得任何奖状，显示：
```
暂无荣誉记录
```

#### 7.2 统计信息为空

如果统计信息全部为0，统计卡片显示为0。

### 8. 数据流程

#### 8.1 数据获取流程

1. 用户进入个人中心页面
2. 切换到"荣誉墙"标签页
3. 调用 `GET /api/user/rewards` 接口
4. 后端查询 `rewards` 表，获取该用户的所有奖励记录
5. 按 `created_at` 倒序排列
6. 计算统计信息和格式化奖状数据
7. 返回给前端展示

#### 8.2 数据更新流程

- **自动更新**：每周一21:00自动结算后，新的奖励记录会自动出现在荣誉墙
- **手动更新**：管理员手动结算后，新的奖励记录会立即出现在荣誉墙
- **实时性**：用户刷新页面即可看到最新的奖状

### 9. UI/UX 设计

#### 9.1 布局设计

- **网格布局**：2列网格，响应式设计
- **卡片间距**：`gap-4`（16px）
- **卡片样式**：圆角、边框、阴影

#### 9.2 颜色方案

- **冠军**：金色系（`from-yellow-400 to-yellow-600`）
- **亚军**：灰色系（`from-gray-300 to-gray-500`）
- **季军**：橙色系（`from-orange-400 to-orange-600`）
- **参与奖**：蓝色系（`from-blue-400 to-blue-600`）

#### 9.3 交互反馈

- **悬停效果**：阴影加深、显示操作按钮
- **点击反馈**：卡片可点击，准备扩展更多功能
- **加载状态**：数据加载时显示加载动画

### 10. 技术实现

#### 10.1 前端组件

- **位置**：`app/profile/page.tsx`
- **标签页**：使用 `shadcn/ui` 的 `Tabs` 组件
- **卡片**：使用 `shadcn/ui` 的 `Card` 组件
- **按钮**：使用 `shadcn/ui` 的 `Button` 组件

#### 10.2 后端接口

- **位置**：`app/api/user/rewards/route.ts`
- **认证**：使用 JWT Token 验证用户身份
- **数据库查询**：使用 Prisma ORM 查询 `rewards` 表

#### 10.3 工具函数

- **日期计算**：`lib/week.ts` 中的 `getWeekMonday()` 函数
- **周编号解析**：从 `week_number`（YYYYWW格式）解析年份和周数

### 11. 注意事项

#### 11.1 性能考虑

- 奖状图片可能较大，建议使用 CDN 加速
- 图片懒加载：可以考虑实现图片懒加载优化
- 数据缓存：前端可以考虑缓存荣誉墙数据

#### 11.2 兼容性

- 图片格式：支持常见图片格式（JPG、PNG、GIF等）
- 浏览器兼容：需要支持现代浏览器（Chrome、Safari、Firefox等）
- 移动端适配：响应式设计，适配移动端和PC端

#### 11.3 错误处理

- **图片加载失败**：自动回退到占位符
- **API 请求失败**：显示错误提示
- **数据为空**：显示空状态提示

### 12. 未来扩展

#### 12.1 计划功能

- **保存功能**：实现真正的保存到相册功能
- **分享功能**：支持分享到社交媒体
- **筛选功能**：按年份、类型筛选奖状
- **详情页面**：点击奖状查看详细信息

#### 12.2 优化方向

- **图片优化**：压缩图片、使用 WebP 格式
- **加载优化**：实现虚拟滚动、分页加载
- **动画效果**：添加更丰富的动画效果

---

*最后更新：2025年1月*

