# 6. 奖励配置功能实现

## 📋 概述

本文档说明奖励配置功能的实现细节，包括奖状底图的上传、配置和管理功能。

## 🎯 功能清单

### 1. 配置类型

#### 1.1 默认配置
- **用途**：为所有周设置默认的奖状底图
- **标识**：`week_number` 为 `null`
- **优先级**：当某周没有特殊配置时，使用默认配置

#### 1.2 指定周配置
- **用途**：为特定周设置特殊的奖状底图（如节日限定、特殊活动等）
- **标识**：`week_number` 为具体的周编号（YYYYWW格式）
- **优先级**：高于默认配置，如果某周有特殊配置，优先使用特殊配置

### 2. 底图类型

系统支持4种奖状底图：

1. **冠军底图**（第1名）：`img_gold`
2. **亚军底图**（第2名）：`img_silver`
3. **季军底图**（第3名）：`img_bronze`
4. **参与奖底图**（第4名及以后）：`img_participate`

### 3. 配置优先级

- **指定周配置** > **默认配置**
- 如果某周有特殊配置，使用特殊配置的底图
- 如果某周没有特殊配置，使用默认配置的底图

### 4. 管理页面功能 (`/admin`)

#### 4.1 配置类型选择
- 单选按钮：选择"默认配置"或"指定周配置"
- 如果选择"指定周配置"，需要输入年份和周数

#### 4.2 底图上传和配置
每个底图支持两种方式：

**方式1：上传到OSS（推荐）**
- 点击上传按钮选择图片
- 自动上传到OSS
- 上传成功后自动填充URL到输入框
- 显示上传状态（加载动画）

**方式2：直接输入URL**
- 手动输入完整的HTTP/HTTPS链接
- 支持外部图片链接

#### 4.3 图片预览
- 如果URL有效，自动显示图片预览
- 使用 `object-contain` 模式，完整显示图片
- 预览失败时自动隐藏

#### 4.4 配置操作
- **加载配置**：手动点击按钮加载已有配置
- **保存配置**：保存当前配置到数据库

### 5. API 接口

#### 5.1 获取配置

**路径**：`GET /api/admin/cert-config`

**请求参数**：
- `weekNumber`（可选）：周编号（YYYYWW格式），不传则查询默认配置

**请求示例**：
```bash
# 获取默认配置
GET /api/admin/cert-config

# 获取指定周配置
GET /api/admin/cert-config?weekNumber=202550
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "id": "1",
    "weekNumber": null,
    "isDefault": true,
    "imgGold": "https://example.com/cert/gold.jpg",
    "imgSilver": "https://example.com/cert/silver.jpg",
    "imgBronze": "https://example.com/cert/bronze.jpg",
    "imgParticipate": "https://example.com/cert/participate.jpg"
  }
}
```

#### 5.2 保存配置

**路径**：`POST /api/admin/cert-config`

**请求体**：
```json
{
  "weekNumber": null,
  "imgGold": "https://example.com/cert/gold.jpg",
  "imgSilver": "https://example.com/cert/silver.jpg",
  "imgBronze": "https://example.com/cert/bronze.jpg",
  "imgParticipate": "https://example.com/cert/participate.jpg"
}
```

**参数说明**：
- `weekNumber`：周编号（YYYYWW格式），`null` 表示默认配置
- `imgGold`：冠军底图URL（必填）
- `imgSilver`：亚军底图URL（必填）
- `imgBronze`：季军底图URL（必填）
- `imgParticipate`：参与奖底图URL（必填）

**响应示例**：
```json
{
  "code": 200,
  "msg": "保存成功",
  "data": {
    "id": "1",
    "weekNumber": null,
    "isDefault": true,
    "imgGold": "https://example.com/cert/gold.jpg",
    "imgSilver": "https://example.com/cert/silver.jpg",
    "imgBronze": "https://example.com/cert/bronze.jpg",
    "imgParticipate": "https://example.com/cert/participate.jpg"
  }
}
```

#### 5.3 删除配置

**路径**：`DELETE /api/admin/cert-config?weekNumber=202550`

**请求参数**：
- `weekNumber`：周编号（必填），不能删除默认配置

**响应示例**：
```json
{
  "code": 200,
  "msg": "删除成功"
}
```

### 6. 图片上传接口

#### 6.1 上传奖状底图

**路径**：`POST /api/upload/cert`

**请求体**：`FormData`
- `file`：图片文件
- `type`：图片类型（gold, silver, bronze, participate）

**文件限制**：
- 文件类型：图片格式（image/*）
- 文件大小：最大 10MB

**响应示例**：
```json
{
  "code": 200,
  "msg": "上传成功",
  "data": {
    "url": "https://weighin-media.oss-cn-wuhan-Ir.aliyuncs.com/certs/gold-1767861927198.jpg"
  }
}
```

#### 6.2 上传路径

图片上传到OSS的路径格式：
- `certs/gold-{timestamp}.{ext}`（冠军）
- `certs/silver-{timestamp}.{ext}`（亚军）
- `certs/bronze-{timestamp}.{ext}`（季军）
- `certs/participate-{timestamp}.{ext}`（参与奖）

### 7. 数据库表结构

#### 7.1 cert_configs 表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BigInt | 主键 |
| week_number | Int | 周编号（YYYYWW格式），NULL表示默认配置 |
| img_gold | String | 冠军底图URL |
| img_silver | String | 亚军底图URL |
| img_bronze | String | 季军底图URL |
| img_participate | String | 参与奖底图URL |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

#### 7.2 唯一约束

- `week_number` 唯一约束：确保每个周只有一个配置（包括默认配置）

### 8. 使用场景

#### 8.1 设置默认配置

1. 进入管理页面：`/admin`
2. 切换到"奖励配置"标签页
3. 选择"默认配置"
4. 上传或输入4种底图的URL
5. 点击"保存配置"

#### 8.2 为特定周设置特殊配置

1. 进入管理页面：`/admin`
2. 切换到"奖励配置"标签页
3. 选择"指定周配置"
4. 输入年份和周数（如：2025年第50周）
5. 点击"加载配置"查看是否已有配置
6. 上传或输入4种底图的URL
7. 点击"保存配置"

#### 8.3 编辑已有配置

1. 选择配置类型（默认或指定周）
2. 如果是指定周，输入年份和周数
3. 点击"加载配置"按钮
4. 修改底图URL或上传新图片
5. 点击"保存配置"

### 9. 注意事项

#### 9.1 配置规则

- **默认配置必须存在**：建议先设置默认配置，确保所有周都有底图可用
- **不能删除默认配置**：删除接口不允许删除默认配置（week_number 为 null）
- **每个周只能有一个配置**：如果某周已有配置，保存时会更新而不是创建新记录

#### 9.2 图片要求

- **格式**：支持常见图片格式（JPG、PNG、GIF等）
- **大小**：建议不超过 10MB
- **URL格式**：必须是完整的HTTP或HTTPS链接
- **存储**：推荐上传到OSS，确保图片可访问

#### 9.3 配置优先级

- 生成奖状时，优先查找该周的特殊配置
- 如果该周没有特殊配置，使用默认配置
- 如果默认配置也不存在，可能无法生成奖状

#### 9.4 权限控制

- API 接口支持通过 `ADMIN_SECRET` 环境变量控制访问
- 管理页面目前无权限控制，建议添加（如需要）

### 10. 错误处理

#### 10.1 常见错误

- **请填写所有底图URL**：4种底图都必须填写
- **底图URL格式不正确**：URL必须以 http:// 或 https:// 开头
- **该周已存在配置**：如果某周已有配置，保存时会更新而不是报错
- **不能删除默认配置**：尝试删除默认配置时会返回错误

#### 10.2 错误响应

```json
{
  "code": 400,
  "msg": "请填写所有底图URL"
}
```

### 11. 最佳实践

#### 11.1 配置顺序

1. **先设置默认配置**：确保所有周都有底图可用
2. **再设置特殊配置**：为特定周设置特殊底图

#### 11.2 图片管理

- **使用OSS存储**：推荐上传到OSS，确保图片稳定可访问
- **图片命名**：建议使用有意义的文件名，便于管理
- **定期检查**：确保图片URL有效，避免404错误

#### 11.3 配置管理

- **定期备份**：建议定期备份配置数据
- **版本控制**：如果需要回滚，可以保存历史配置
- **测试验证**：保存配置后，建议测试生成奖状功能

### 12. 测试建议

#### 12.1 功能测试

- 测试默认配置的保存和加载
- 测试指定周配置的保存和加载
- 测试图片上传功能
- 测试配置更新功能
- 测试配置删除功能（不能删除默认配置）

#### 12.2 边界测试

- 测试空URL的处理
- 测试无效URL的处理
- 测试重复配置的处理
- 测试删除不存在的配置

#### 12.3 集成测试

- 测试配置与奖状生成功能的集成
- 测试配置优先级是否正确
- 测试默认配置的兜底逻辑

---

*最后更新：2025年1月*

