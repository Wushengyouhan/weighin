# 个人页面与头像上传功能实现说明

## ✅ 已完成功能

### 1. 个人页面 (`/profile`)

#### 1.1 个人信息展示和编辑
- ✅ 用户头像显示
- ✅ 用户昵称显示
- ✅ 编辑资料功能（头像上传、昵称修改）
- ✅ 退出登录功能

#### 1.2 体重趋势 Tab
- ✅ 统计卡片展示
  - 累计减重（显示总减重数值和变化范围）
  - 参与周数（显示总周数和平均每周减重）
- ✅ 体重变化曲线图（使用 recharts）
  - 折线图展示体重变化趋势
  - X 轴：日期（周）
  - Y 轴：体重（kg）
- ✅ 打卡历史列表
  - 按时间倒序显示所有打卡记录
  - 每条记录显示：周次、日期、体重、与上周的差值（↑/↓）

#### 1.3 荣誉墙 Tab
- ✅ 成就统计（冠军、亚军、季军、参与奖数量）
- ✅ 奖状网格展示
- ✅ 奖状保存和分享功能（UI 已实现）

### 2. API 接口

#### 2.1 用户信息接口
- **路径**：`GET /api/user/profile`
- **功能**：获取当前用户信息
- **认证**：需要 Bearer Token

- **路径**：`PATCH /api/user/profile`
- **功能**：更新用户信息（昵称、头像）
- **参数**：
  ```json
  {
    "nickname": "用户昵称",
    "avatar": "头像 URL"
  }
  ```

#### 2.2 打卡历史接口
- **路径**：`GET /api/user/checkins`
- **功能**：获取打卡历史和统计数据
- **返回数据**：
  - `stats`：统计数据（累计减重、参与周数等）
  - `history`：打卡历史列表
  - `chartData`：图表数据

#### 2.3 荣誉墙接口
- **路径**：`GET /api/user/rewards`
- **功能**：获取荣誉墙数据
- **返回数据**：
  - `stats`：各类奖励数量统计
  - `certificates`：奖状列表

### 3. 头像上传功能（阿里云 OSS）

#### 3.1 上传接口
- **路径**：`POST /api/upload/avatar`
- **功能**：上传头像到阿里云 OSS
- **参数**：FormData 格式，字段名为 `file`
- **限制**：
  - 文件类型：仅图片（image/*）
  - 文件大小：最大 5MB
- **返回**：OSS 图片 URL

#### 3.2 OSS 配置
- **存储位置**：`weighin-media` Bucket
- **文件路径**：`avatars/{userId}-{timestamp}.{ext}`
- **配置项**（`.env` 文件）：
  ```env
  OSS_REGION="oss-cn-wuhan-lr"
  OSS_ENDPOINT="https://oss-cn-wuhan-lr.aliyuncs.com"
  OSS_ACCESS_KEY_ID="your-access-key-id"
  OSS_ACCESS_KEY_SECRET="your-access-key-secret"
  OSS_BUCKET="weighin-media"
  ```

### 4. 底部导航栏

#### 4.1 导航组件 (`components/BottomNav.tsx`)
- ✅ 固定底部导航栏
- ✅ 四个导航项：首页、打卡、排行榜、我的
- ✅ 当前页面高亮显示
- ✅ 响应式设计

#### 4.2 页面集成
- ✅ 主页 (`/home`)
- ✅ 打卡页 (`/checkin`)
- ✅ 排行榜页 (`/leaderboard`)
- ✅ 个人页 (`/profile`)

### 5. 主页更新

#### 5.1 页面内容
- ✅ 欢迎卡片（显示用户头像和昵称）
- ✅ 本周挑战状态卡片
- ✅ 快捷入口（排行榜、体重趋势、荣誉墙、我的）
- ✅ 上周战况展示

#### 5.2 交互功能
- ✅ 右上角头像可点击跳转到个人页面
- ✅ 快捷入口卡片可点击跳转到对应页面

### 6. 其他页面框架

#### 6.1 打卡页面 (`/checkin`)
- ✅ 基础 UI 框架
- ⏳ 功能待实现

#### 6.2 排行榜页面 (`/leaderboard`)
- ✅ 基础 UI 框架
- ⏳ 功能待实现

## 📁 文件结构

### 新增文件

```
app/
├── api/
│   ├── upload/
│   │   └── avatar/
│   │       └── route.ts          # 头像上传接口
│   └── user/
│       ├── profile/
│       │   └── route.ts          # 用户信息接口
│       ├── checkins/
│       │   └── route.ts          # 打卡历史接口
│       └── rewards/
│           └── route.ts          # 荣誉墙接口
├── profile/
│   └── page.tsx                  # 个人页面
├── checkin/
│   └── page.tsx                  # 打卡页面（框架）
├── leaderboard/
│   └── page.tsx                  # 排行榜页面（框架）
└── home/
    └── page.tsx                  # 主页（已更新）

components/
└── BottomNav.tsx                 # 底部导航栏组件
```

## 🔧 技术实现

### 1. 头像上传流程

1. 用户选择图片文件
2. 前端验证文件类型和大小
3. 转换为 FormData 格式
4. 发送 POST 请求到 `/api/upload/avatar`
5. 后端验证并上传到 OSS
6. 返回 OSS URL
7. 前端更新头像显示
8. 保存头像 URL 到数据库

### 2. OSS 集成

- **SDK**：`ali-oss`
- **配置方式**：环境变量（`.env` 文件）
- **存储策略**：直接存储到 OSS，数据库只保存 URL
- **文件命名**：`avatars/{userId}-{timestamp}.{ext}`

### 3. 数据获取

- 使用 Zustand 管理用户状态
- API 请求携带 Bearer Token 进行认证
- 使用 React Hooks 管理组件状态

## 📝 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 数据库连接配置
DATABASE_URL="mysql://user:password@localhost:3306/database"

# JWT 密钥
JWT_SECRET="your-secret-key"

# OSS 配置
OSS_REGION="oss-cn-wuhan-lr"
OSS_ENDPOINT="https://oss-cn-wuhan-lr.aliyuncs.com"
OSS_ACCESS_KEY_ID="your-access-key-id"
OSS_ACCESS_KEY_SECRET="your-access-key-secret"
OSS_BUCKET="weighin-media"
```

## 🚀 使用说明

### 1. 访问个人页面

- 登录后，点击底部导航栏的"我的"
- 或点击主页右上角的头像
- 或点击主页快捷入口中的"我的"

### 2. 编辑个人信息

1. 在个人页面点击"编辑资料"按钮
2. 点击头像上的相机图标选择新头像
3. 修改昵称
4. 点击"保存"按钮

### 3. 查看数据

- **体重趋势**：点击"体重趋势" Tab 查看统计数据和图表
- **荣誉墙**：点击"荣誉墙" Tab 查看成就和奖状

## ⚠️ 注意事项

1. **OSS 配置**：确保 `.env` 文件中的 OSS 配置正确
2. **权限设置**：确保 RAM 用户有 OSS Bucket 的写入权限
3. **环境变量**：修改 `.env` 后需要重启开发服务器
4. **头像存储**：头像存储在 OSS，数据库只保存 URL
5. **文件大小限制**：头像大小限制为 5MB

## 🔄 待开发功能

- [ ] 打卡功能完整实现
- [ ] 排行榜功能完整实现
- [ ] 主页数据动态展示
- [ ] 奖状图片生成和下载
- [ ] 头像压缩功能

---

*最后更新：2026年1月*

