# 5. 结算功能实现

## 📋 概述

本文档说明排名结算功能的实现细节，包括自动结算、手动结算、批量结算等功能。

## 🎯 功能清单

### 1. 结算逻辑

#### 1.1 结算规则
- **参与条件**：只有上周和本周都有打卡的用户才能参与排名
- **排名计算**：根据 `weightDiff = 上周体重 - 本周体重` 计算
- **排序规则**：
  - 按 `weightDiff` 降序排列（减重越多排名越高）
  - 如果 `weightDiff` 相同，按打卡时间升序排列（先打卡的排名靠前）
- **奖励类型**：
  - `rank = 1`：冠军（type = 1）
  - `rank = 2`：亚军（type = 2）
  - `rank = 3`：季军（type = 3）
  - `rank >= 4`：参与奖（type = 4）

#### 1.2 结算时机
- **自动结算**：每周一 21:00 自动执行（使用 node-cron 定时任务）
- **手动结算**：通过管理页面或 API 接口手动触发

#### 1.3 默认行为
- **默认强制重新结算**：如果某周已经结算过，再次结算会删除旧数据并重新计算
- **幂等性**：如果明确指定 `force=false`，已结算的周会跳过

### 2. 结算服务 (`lib/settlement.ts`)

#### 2.1 核心函数

**`settleWeekRanking(weekNumber, force)`**
- 功能：结算指定周的排名
- 参数：
  - `weekNumber`: 周编号（YYYYWW格式，如 202550）
  - `force`: 是否强制重新结算（默认 `true`）
- 返回：结算结果对象

**`startSettlementCron()`**
- 功能：启动定时结算任务
- 执行时间：每周一 21:00（北京时间）
- 时区：Asia/Shanghai

#### 2.2 结算流程

1. **检查是否已结算**（如果 `force=false`）
   - 如果已结算，直接返回"已结算过"

2. **删除旧数据**（如果 `force=true` 或默认）
   - 删除该周的所有旧结算记录

3. **查询打卡记录**
   - 查询本周所有打卡记录
   - 查询上周所有打卡记录

4. **筛选符合条件的用户**
   - 只保留上周和本周都有打卡的用户

5. **计算排名**
   - 计算每个用户的 `weightDiff`
   - 按规则排序

6. **保存到数据库**
   - 将排名结果保存到 `rewards` 表

### 3. API 接口

#### 3.1 单个周结算

**路径**：`POST /api/admin/settle`

**请求参数**：
- `week`（可选）：周数（1-53）
- `year`（可选）：年份（如 2025）
- `force`（可选）：是否强制重新结算（默认 `true`，传 `false` 则不重新结算）

**请求示例**：
```bash
# 结算当前周
POST /api/admin/settle

# 结算指定周
POST /api/admin/settle?week=50&year=2025

# 不强制重新结算（如果已结算则跳过）
POST /api/admin/settle?week=50&year=2025&force=false
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "结算成功",
  "data": {
    "weekNumber": 202550,
    "count": 15
  }
}
```

### 4. 管理页面 (`/admin`)

#### 4.1 页面功能

**单个周结算**：
- 输入年份和周数
- 支持强制重新结算（默认勾选）
- 一键结算当前周

**结算结果展示**：
- 成功：绿色提示，显示参与排名用户数
- 已结算：黄色提示（仅在 `force=false` 时出现）
- 失败：红色提示，显示错误信息

#### 4.2 访问地址

- **开发环境**：`http://localhost:3000/admin`
- **生产环境**：`https://your-domain.com/admin`

### 5. 定时任务

#### 5.1 启动方式

定时任务在应用启动时自动启动，通过 `lib/init-settlement.ts` 初始化：

```typescript
// app/layout.tsx
import "@/lib/init-settlement"
```

#### 5.2 执行时间

- **时间**：每周一 21:00
- **时区**：Asia/Shanghai（北京时间）
- **Cron 表达式**：`0 21 * * 1`

#### 5.3 日志输出

- 启动时：`定时结算任务已启动：每周一 21:00 执行`
- 执行时：`开始执行定时结算任务...`
- 完成时：`定时结算任务完成: { result }`
- 失败时：`定时结算任务失败: { error }`

### 6. 数据库表结构

#### 6.1 rewards 表

结算结果保存在 `rewards` 表中：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BigInt | 主键 |
| user_id | BigInt | 用户ID |
| week_number | Int | 周编号（YYYYWW格式） |
| weight_diff | Decimal | 减重差值（kg） |
| rank | Int | 排名（1=冠军，2=亚军，3=季军，4+=参与奖） |
| type | Int | 奖励类型（1=冠军，2=亚军，3=季军，4=参与奖） |
| certificate_url | String | 奖状图片URL（可选） |
| created_at | DateTime | 创建时间 |

#### 6.2 唯一约束

- `(user_id, week_number)` 唯一约束：确保每个用户每周只有一条奖励记录

### 7. 使用场景

#### 7.1 自动结算

系统会在每周一 21:00 自动结算当前周的排名，无需人工干预。

#### 7.2 补结算历史周

如果前几周有打卡数据但没有结算，可以通过管理页面或 API 手动补结算：

```bash
# 补结算 2025年第50周
POST /api/admin/settle?week=50&year=2025
```

#### 7.3 重新结算

如果某周结算后又补了打卡数据，需要重新结算：

```bash
# 强制重新结算（默认行为）
POST /api/admin/settle?week=50&year=2025

# 或明确指定 force=true
POST /api/admin/settle?week=50&year=2025&force=true
```

### 8. 注意事项

#### 8.1 时区设置

- 定时任务使用 `Asia/Shanghai` 时区
- 确保服务器时区设置正确
- Docker 部署时注意时区配置

#### 8.2 进程管理

- 确保应用进程持续运行（使用 PM2 或类似工具）
- 定时任务只在应用启动时初始化一次

#### 8.3 数据一致性

- 结算时会删除旧数据并重新计算，确保数据一致性
- 建议在结算前备份数据（如果需要）

#### 8.4 性能考虑

- 批量结算时，建议按时间顺序结算（从早到晚）
- 大量数据结算时，可能需要较长时间

#### 8.5 权限控制

- API 接口支持通过 `ADMIN_SECRET` 环境变量控制访问
- 管理页面目前无权限控制，建议添加（如需要）

### 9. 错误处理

#### 9.1 常见错误

- **该周没有打卡记录**：返回 `count: 0`
- **该周没有符合条件的用户**：返回 `count: 0`（上周和本周都有打卡的用户数为 0）
- **该周已经结算过**：仅在 `force=false` 时返回，提示已结算

#### 9.2 错误响应

```json
{
  "code": 400,
  "msg": "该周已经结算过",
  "data": {
    "weekNumber": 202550,
    "alreadySettled": true,
    "count": 15
  }
}
```

### 10. 测试建议

#### 10.1 单元测试

- 测试结算逻辑：筛选符合条件的用户
- 测试排名计算：排序规则是否正确
- 测试强制重新结算：是否删除旧数据

#### 10.2 集成测试

- 测试 API 接口：单个结算、批量结算
- 测试定时任务：是否按时执行
- 测试边界情况：空数据、已结算等

#### 10.3 手动测试

1. 创建测试数据（上周和本周都有打卡）
2. 调用结算接口
3. 检查 `rewards` 表中的数据
4. 验证排名是否正确

---

*最后更新：2025年1月*

