# 排行榜功能实现

## 功能概述

排行榜功能用于展示每周的减重排名，显示已结算周的排名数据。用户可以选择不同周查看历史排行榜。

## 核心功能

### 1. 周列表查询
- 从 `rewards` 表查询所有已结算的周
- 按周编号降序排列（最新的在前）
- 过滤无效周数（只保留1-53之间的周）
- 如果数据库为空，默认显示202550周

### 2. 排行榜展示
- **Top 3 特殊展示**：
  - 第1名：金色渐变背景、"冠军"徽章、皇冠图标
  - 第2名：灰色渐变背景、"亚军"徽章、奖牌图标
  - 第3名：橙色渐变背景、"季军"徽章、奖牌图标
  - 显示减重数值（kg）
- **Rank 4+ 列表展示**：
  - 简洁的卡片样式
  - 显示排名、头像、昵称、减重数值
- **结算时间提示**：
  - 已结算：显示结算时间
  - 未结算：显示"等待结算（每周一 21:00 自动结算）"

### 3. 用户交互
- 点击头像或昵称跳转到用户个人主页
- 下拉菜单选择不同周查看历史排行榜

## API 接口

### 1. 获取周列表
**路径**：`GET /api/leaderboard/weeks`

**功能**：获取所有已结算的周列表

**返回数据**：
```typescript
{
  code: 200,
  msg: 'success',
  data: {
    weeks: Array<{
      week: number,        // 周数（1-53）
      year: number,        // 年份
      weekNumber: number, // 周编号（YYYYWW格式）
      label: string        // 显示标签（如"2025年第50周"）
    }>
  }
}
```

### 2. 获取排行榜数据
**路径**：`GET /api/leaderboard?week=50&year=2025`

**请求参数**：
- `week`（可选）：周数（1-53）
- `year`（可选）：年份
- 都不传：查询当前周

**返回数据**：
```typescript
{
  code: 200,
  msg: 'success',
  data: {
    week: number,              // 周数
    weekNumber: number,        // 周编号（YYYYWW格式）
    year: number,              // 年份
    settled: boolean,           // 是否已结算
    settledAt: string | null,  // 结算时间（ISO格式）
    users: Array<{
      rank: number,            // 排名
      userId: number,          // 用户ID
      nickname: string,        // 昵称
      avatar: string | null,   // 头像URL
      weightDiff: number       // 减重差值（kg）
    }>
  }
}
```

## 关键逻辑

### 1. 数据来源
- 排行榜数据来自 `rewards` 表（结算后生成）
- 只显示已结算的周，未结算的周不显示

### 2. 排名规则
- 按 `weight_diff`（减重差值）降序排列
- 减重越多排名越高
- 只有上周和本周都有打卡的用户才能参与排名

### 3. 周编号计算
- 格式：`YYYYWW`（如 202550 表示 2025年第50周）
- 跨年周处理：第1周的上一周是上一年的最后一周

### 4. 默认行为
- 页面加载时自动选择最新的周
- 如果数据库中没有数据，默认显示202550周

## 数据字段说明

### rewards 表字段
- `week_number`：周编号（YYYYWW格式）
- `user_id`：用户ID
- `weight_diff`：减重差值（上周体重 - 本周体重）
- `rank`：排名（1=冠军，2=亚军，3=季军，4+=参与奖）
- `type`：奖励类型（1=冠军，2=亚军，3=季军，4=参与奖）
- `certificate_url`：奖状图片URL
- `created_at`：结算时间

### 用户信息字段
- `nickname`：用户昵称（如果没有则显示"用户{userId}"）
- `avatar`：头像URL（如果没有则为null）

## 注意事项

1. **数据一致性**：排行榜数据在每周一21:00自动结算时生成，保存在 `rewards` 表中
2. **空数据处理**：如果某周没有结算数据，显示"等待结算"提示
3. **无效周数过滤**：自动过滤掉周数不在1-53范围内的数据
4. **跨年周处理**：正确处理跨年周的上一周计算逻辑

