# 名人堂功能实现思路

## 📋 功能需求

1. **展示历史前5的用户**
2. **积分计算规则**：
   - 第1名（冠军）：5分
   - 第2名（亚军）：3分
   - 第3名（季军）：2分
   - 参与奖：1分
3. **UI界面**：参考 `/Users/chenchen/Desktop/app/Weekly Weight Challenge App`

## 🎯 实现思路

### 1. 数据来源

从 `rewards` 表查询所有历史奖励记录，根据 `type` 字段计算积分：
- `type = 1`（冠军）→ 5分
- `type = 2`（亚军）→ 3分
- `type = 3`（季军）→ 2分
- `type = 4`（参与奖）→ 1分

### 2. API 接口设计

**路径**：`GET /api/hall-of-fame`

**功能**：
- 查询所有用户的奖励记录
- 按用户分组统计：
  - 冠军数量（type = 1）
  - 亚军数量（type = 2）
  - 季军数量（type = 3）
  - 参与奖数量（type = 4）
  - 总积分（根据积分规则计算）
  - 参与周数（总奖励记录数）
- 按总积分降序排序，取前5名
- 关联用户信息（昵称、头像）

**返回数据格式**：
```typescript
{
  code: 200,
  msg: 'success',
  data: {
    users: Array<{
      rank: number,              // 名人堂排名（1-5）
      userId: number,            // 用户ID
      nickname: string,          // 昵称
      avatar: string | null,     // 头像URL
      champion: number,           // 冠军次数
      runnerUp: number,          // 亚军次数
      third: number,             // 季军次数
      participant: number,        // 参与奖次数
      totalScore: number,         // 总积分
      totalWeeks: number         // 参与周数
    }>
  }
}
```

### 3. 数据库查询逻辑

**方案一：使用 SQL 聚合查询（推荐）**
```sql
SELECT 
  r.user_id,
  COUNT(CASE WHEN r.type = 1 THEN 1 END) as champion,
  COUNT(CASE WHEN r.type = 2 THEN 1 END) as runnerUp,
  COUNT(CASE WHEN r.type = 3 THEN 1 END) as third,
  COUNT(CASE WHEN r.type = 4 THEN 1 END) as participant,
  COUNT(*) as totalWeeks,
  SUM(
    CASE r.type
      WHEN 1 THEN 5
      WHEN 2 THEN 3
      WHEN 3 THEN 2
      WHEN 4 THEN 1
      ELSE 0
    END
  ) as totalScore
FROM rewards r
GROUP BY r.user_id
ORDER BY totalScore DESC
LIMIT 5
```

**方案二：使用 Prisma 查询（在内存中计算）**
1. 查询所有 rewards 记录
2. 按 user_id 分组统计
3. 计算每个用户的积分和统计信息
4. 排序取前5名

### 4. 前端页面实现

**页面路径**：`/app/hall-of-fame/page.tsx`

**UI结构**（参考参考项目）：
1. **顶部标题**：
   - 皇冠图标 + "名人堂"标题
   - "历史荣誉总排名"副标题

2. **积分规则说明卡片**：
   - 显示积分规则：🥇 冠军 = 5分，🥈 亚军 = 3分，🥉 季军 = 2分，📅 参与奖 = 1分

3. **Top 3 特殊展示**：
   - **第1名（殿堂之王）**：
     - 金色渐变背景和边框
     - 皇冠图标 + "殿堂之王"徽章
     - 显示总积分（大号字体）
     - 获奖统计：冠军、亚军、季军、参与周数（4列网格）
   - **第2名（名人堂银冠）**：
     - 银色渐变背景和边框
     - 奖牌图标 + "名人堂银冠"徽章
     - 显示总积分
     - 获奖统计
   - **第3名（名人堂铜冠）**：
     - 橙色渐变背景和边框
     - 奖牌图标 + "名人堂铜冠"徽章
     - 显示总积分
     - 获奖统计

4. **Rank 4-5 列表展示**：
   - 简洁的卡片样式
   - 显示排名、头像、昵称
   - 显示获奖统计（冠军、亚军、季军数量）
   - 显示总积分

5. **用户交互**：
   - 点击头像或昵称跳转到用户个人主页
   - 悬停效果

6. **底部说明**：
   - "名人堂根据历史所有周期的排名综合计算，展示最具毅力的挑战者"

### 5. 实现步骤

#### 阶段1：API 接口实现
1. 创建 `app/api/hall-of-fame/route.ts`
2. 实现查询逻辑：
   - 查询所有 rewards 记录（关联 users 表）
   - 按 user_id 分组统计
   - 计算积分和统计信息
   - 排序取前5名
3. 返回格式化数据

#### 阶段2：前端页面实现
1. 创建 `app/home/page.tsx` 中的"名人堂"入口（已移除跳转，需要恢复）
2. 创建 `app/hall-of-fame/page.tsx`
3. 实现 UI 组件：
   - Top 3 卡片组件
   - Rank 4-5 列表组件
   - 积分规则说明卡片
4. 实现数据获取和状态管理
5. 添加防重复调用机制（useRef）

#### 阶段3：优化和测试
1. 性能优化（如果数据量大，考虑缓存）
2. UI 优化（响应式布局、动画效果）
3. 空状态处理（如果用户少于5个）
4. 测试不同数据场景

### 6. 关键逻辑

#### 积分计算
```typescript
function calculateScore(type: number): number {
  switch (type) {
    case 1: return 5  // 冠军
    case 2: return 3  // 亚军
    case 3: return 2  // 季军
    case 4: return 1  // 参与奖
    default: return 0
  }
}
```

#### 排名规则
1. 按总积分降序排列
2. 如果总积分相同，按参与周数降序排列（参与周数多的排名靠前）
3. 如果都相同，按用户ID升序排列（保证排序稳定）

#### 数据统计
- 冠军数量：`COUNT(type = 1)`
- 亚军数量：`COUNT(type = 2)`
- 季军数量：`COUNT(type = 3)`
- 参与奖数量：`COUNT(type = 4)`
- 参与周数：`COUNT(*)`（所有奖励记录数）
- 总积分：`SUM(calculateScore(type))`

### 7. 注意事项

1. **数据一致性**：只统计 `rewards` 表中已结算的数据
2. **空数据处理**：如果用户少于5个，只显示实际用户数
3. **性能考虑**：如果数据量大，可以考虑：
   - 添加缓存（Redis 或内存缓存）
   - 定期更新统计数据
   - 使用数据库索引优化查询
4. **排名更新**：每次结算后，名人堂排名可能会变化，但不需要实时更新，可以按需刷新

### 8. 数据库优化建议

如果需要频繁查询，可以考虑：
- 在 `rewards` 表上添加 `(user_id, type)` 的复合索引
- 或者创建物化视图/汇总表存储用户积分统计（定期更新）
