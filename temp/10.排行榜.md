# æ’è¡Œæ¦œåŠŸèƒ½è®¾è®¡ä¸å®ç°

## ğŸ“‹ ç›®å½•
1. [åŠŸèƒ½éœ€æ±‚](#åŠŸèƒ½éœ€æ±‚)
2. [API æ¥å£è®¾è®¡](#api-æ¥å£è®¾è®¡)
3. [æ•°æ®åº“æŸ¥è¯¢é€»è¾‘](#æ•°æ®åº“æŸ¥è¯¢é€»è¾‘)
4. [å‰ç«¯é¡µé¢å®ç°](#å‰ç«¯é¡µé¢å®ç°)
5. [æ’åè®¡ç®—é€»è¾‘](#æ’åè®¡ç®—é€»è¾‘)
6. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)

---

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

### 1. æ ¸å¿ƒåŠŸèƒ½

#### 1.1 å‘¨æœŸé€‰æ‹©
- **ä¸‹æ‹‰èœå•**ï¼šå¯ä»¥é€‰æ‹©æŸ¥çœ‹ä¸åŒå‘¨æœŸçš„æ’è¡Œæ¦œ
- **é»˜è®¤æ˜¾ç¤º**ï¼šæœ¬å‘¨ï¼ˆå½“å‰å‘¨ï¼‰çš„æ’è¡Œæ¦œ
- **å†å²æŸ¥çœ‹**ï¼šå¯ä»¥æŸ¥çœ‹å¾€æœŸæ¦œå•ï¼ˆå¦‚ï¼š2025å¹´ç¬¬50å‘¨ã€ç¬¬49å‘¨ç­‰ï¼‰
- **å‘¨æ•°æ ¼å¼**ï¼šæ˜¾ç¤ºä¸º "2025å¹´ç¬¬50å‘¨" çš„æ ¼å¼

#### 1.2 ç»“ç®—æ—¶é—´æç¤º
- æ˜¾ç¤ºæœ¬å‘¨ç»“ç®—æ—¶é—´ä¿¡æ¯ï¼ˆæ¯å‘¨ä¸€ 21:00 è‡ªåŠ¨ç»“ç®—ï¼‰
- å¦‚æœå½“å‰å‘¨è¿˜æœªç»“ç®—ï¼Œæ˜¾ç¤º"ç­‰å¾…ç»“ç®—"æç¤º
- å¦‚æœå·²ç»“ç®—ï¼Œæ˜¾ç¤ºç»“ç®—æ—¶é—´

#### 1.3 Top 3 ç‰¹æ®Šå±•ç¤º
å‰ä¸‰åé‡‡ç”¨ç‰¹æ®Šçš„å¡ç‰‡æ ·å¼ï¼š

- **ç¬¬1åï¼ˆå† å†›ï¼‰**ï¼š
  - é‡‘è‰²æ¸å˜èƒŒæ™¯ï¼ˆ`from-yellow-50 to-yellow-100`ï¼‰
  - é‡‘è‰²åœ†å½¢æ’åæ ‡è¯†ï¼ˆ`from-yellow-400 to-yellow-600`ï¼‰
  - çš‡å† å›¾æ ‡ï¼ˆå¯é€‰ï¼‰
  - "å† å†›"å¾½ç« ï¼ˆå¯é€‰ï¼‰
  - æ˜¾ç¤ºå‡é‡æ•°å€¼å’Œç™¾åˆ†æ¯”
  - æ˜¾ç¤ºç”¨æˆ·å¤´åƒã€æ˜µç§°
  
- **ç¬¬2åï¼ˆäºšå†›ï¼‰**ï¼š
  - é“¶è‰²/ç°è‰²æ¸å˜èƒŒæ™¯ï¼ˆ`from-gray-50 to-gray-100`ï¼‰
  - é“¶è‰²åœ†å½¢æ’åæ ‡è¯†ï¼ˆ`from-gray-300 to-gray-500`ï¼‰
  - å¥–ç‰Œå›¾æ ‡ï¼ˆå¯é€‰ï¼‰
  - "äºšå†›"å¾½ç« ï¼ˆå¯é€‰ï¼‰
  - æ˜¾ç¤ºå‡é‡æ•°å€¼å’Œç™¾åˆ†æ¯”
  - æ˜¾ç¤ºç”¨æˆ·å¤´åƒã€æ˜µç§°
  
- **ç¬¬3åï¼ˆå­£å†›ï¼‰**ï¼š
  - é“œè‰²/æ©™è‰²æ¸å˜èƒŒæ™¯ï¼ˆ`from-orange-50 to-orange-100`ï¼‰
  - æ©™è‰²åœ†å½¢æ’åæ ‡è¯†ï¼ˆ`from-orange-400 to-orange-600`ï¼‰
  - å¥–ç‰Œå›¾æ ‡ï¼ˆå¯é€‰ï¼‰
  - "å­£å†›"å¾½ç« ï¼ˆå¯é€‰ï¼‰
  - æ˜¾ç¤ºå‡é‡æ•°å€¼å’Œç™¾åˆ†æ¯”
  - æ˜¾ç¤ºç”¨æˆ·å¤´åƒã€æ˜µç§°

#### 1.4 Rank 4+ åˆ—è¡¨å±•ç¤º
- åˆ—è¡¨å½¢å¼å±•ç¤ºç¬¬4ååŠä»¥åçš„ç”¨æˆ·
- æ˜¾ç¤ºæ’åã€å¤´åƒã€æ˜µç§°ã€å‡é‡æ•°å€¼
- ç®€æ´çš„å¡ç‰‡æ ·å¼ï¼ˆ`bg-gray-50`ï¼‰
- æ’åæ•°å­—æ˜¾ç¤ºåœ¨å·¦ä¾§

#### 1.5 ç”¨æˆ·äº¤äº’
- **ç‚¹å‡»å¤´åƒ**ï¼šè·³è½¬åˆ°è¯¥ç”¨æˆ·çš„ä¸ªäººä¸»é¡µï¼ˆ`/profile/[userId]`ï¼‰
- **ç‚¹å‡»åå­—**ï¼šè·³è½¬åˆ°è¯¥ç”¨æˆ·çš„ä¸ªäººä¸»é¡µ
- **æ‚¬åœæ•ˆæœ**ï¼šå¤´åƒå’Œåå­—åœ¨é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸‹åˆ’çº¿æç¤ºï¼ˆ`hover:underline`ï¼‰

#### 1.6 åº•éƒ¨è¯´æ˜
- æ˜¾ç¤ºæ’åè®¡ç®—è§„åˆ™è¯´æ˜
- è¯´æ˜æ–‡å­—ï¼š"æ’åæ ¹æ®ï¼ˆä¸Šå‘¨ä½“é‡ - æœ¬å‘¨ä½“é‡ï¼‰è®¡ç®—ï¼Œå‡é‡è¶Šå¤šæ’åè¶Šé«˜ã€‚åªæœ‰ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·æ‰èƒ½å‚ä¸æ’åã€‚"

#### 1.7 ç©ºçŠ¶æ€å¤„ç†
- å¦‚æœå½“å‰å‘¨æ²¡æœ‰æ‰“å¡è®°å½•ï¼Œæ˜¾ç¤º"æš‚æ— æ•°æ®"æç¤º
- å¦‚æœé€‰æ‹©çš„å†å²å‘¨æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º"è¯¥å‘¨æš‚æ— æ’è¡Œæ¦œæ•°æ®"

---

## ğŸ”Œ API æ¥å£è®¾è®¡

### æ¥å£è·¯å¾„
`GET /api/leaderboard`

### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| week | number | å¦ | å‘¨æ•°ï¼ˆ1-53ï¼‰ï¼Œä¸ä¼ åˆ™æŸ¥è¯¢å½“å‰å‘¨ |
| year | number | å¦ | å¹´ä»½ï¼ˆå¦‚ 2025ï¼‰ï¼Œä¸ä¼ åˆ™ä½¿ç”¨å½“å‰å¹´ä»½ |

### å‚æ•°å¤„ç†é€»è¾‘
1. å¦‚æœä¼  `week` å’Œ `year`ï¼š
   - è®¡ç®— `weekNumber = year * 100 + week`
   - æŸ¥è¯¢è¯¥å‘¨çš„æ’è¡Œæ¦œ
2. å¦‚æœåªä¼  `week`ï¼š
   - ä½¿ç”¨å½“å‰å¹´ä»½ï¼Œè®¡ç®— `weekNumber = å½“å‰å¹´ä»½ * 100 + week`
3. å¦‚æœéƒ½ä¸ä¼ ï¼š
   - æŸ¥è¯¢å½“å‰å‘¨çš„æ’è¡Œæ¦œï¼ˆä½¿ç”¨ `getWeekNumber()` å‡½æ•°ï¼‰

### å“åº”æ ¼å¼

```typescript
{
  code: 200,
  msg: 'success',
  data: {
    week: 50,                    // å‘¨æ•°ï¼ˆ1-53ï¼‰
    weekNumber: 202550,          // å‘¨ç¼–å·ï¼ˆYYYYWWæ ¼å¼ï¼‰
    year: 2025,                  // å¹´ä»½
    settled: true,                // æ˜¯å¦å·²ç»“ç®—
    settledAt: '2025-12-15 21:00:00', // ç»“ç®—æ—¶é—´ï¼ˆå¦‚æœå·²ç»“ç®—ï¼‰
    users: [
      {
        rank: 1,                 // æ’å
        userId: 1,                // ç”¨æˆ·ID
        nickname: 'å¼ ä¸‰',         // æ˜µç§°
        avatar: 'https://...',   // å¤´åƒURL
        weightDiff: 2.5,         // å‡é‡å·®å€¼ï¼ˆkgï¼‰
        percentage: 3.5,         // å‡é‡ç™¾åˆ†æ¯”
        lastWeight: 82.65,       // ä¸Šå‘¨ä½“é‡
        currentWeight: 80.15,     // æœ¬æ¬¡ä½“é‡
      },
      // ...
    ]
  }
}
```

### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| week | number | å‘¨æ•°ï¼ˆ1-53ï¼‰ |
| weekNumber | number | å‘¨ç¼–å·ï¼ˆYYYYWWæ ¼å¼ï¼Œå¦‚ 202550ï¼‰ |
| year | number | å¹´ä»½ |
| settled | boolean | æ˜¯å¦å·²ç»“ç®— |
| settledAt | string | ç»“ç®—æ—¶é—´ï¼ˆISOæ ¼å¼å­—ç¬¦ä¸²ï¼Œå¦‚æœå·²ç»“ç®—ï¼‰ |
| users | array | æ’è¡Œæ¦œç”¨æˆ·åˆ—è¡¨ï¼ŒæŒ‰æ’åæ’åº |
| users[].rank | number | æ’åï¼ˆ1=å† å†›ï¼Œ2=äºšå†›ï¼Œ3=å­£å†›ï¼Œ4+=å‚ä¸å¥–ï¼‰ |
| users[].userId | number | ç”¨æˆ·ID |
| users[].nickname | string | ç”¨æˆ·æ˜µç§°ï¼ˆå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤º"ç”¨æˆ·{userId}"ï¼‰ |
| users[].avatar | string \| null | å¤´åƒURLï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä¸ºnullï¼‰ |
| users[].weightDiff | number | å‡é‡å·®å€¼ï¼ˆkgï¼‰ï¼Œå¯ä¸ºè´Ÿæ•°ï¼ˆå¢é‡ï¼‰ |
| users[].percentage | number | å‡é‡ç™¾åˆ†æ¯”ï¼ˆä¿ç•™1ä½å°æ•°ï¼‰ |
| users[].lastWeight | number | ä¸Šå‘¨ä½“é‡ï¼ˆkgï¼‰ï¼Œåªæœ‰ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·æ‰æœ‰æ­¤å­—æ®µ |
| users[].currentWeight | number | æœ¬å‘¨ä½“é‡ï¼ˆkgï¼‰ |

### é”™è¯¯å“åº”

```typescript
{
  code: 401,
  msg: 'æœªç™»å½•'
}

{
  code: 404,
  msg: 'è¯¥å‘¨æš‚æ— æ’è¡Œæ¦œæ•°æ®'
}

{
  code: 500,
  msg: 'æœåŠ¡å™¨é”™è¯¯'
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“æŸ¥è¯¢é€»è¾‘

### æ•°æ®æ¥æº

æ’è¡Œæ¦œæ•°æ®ä¸»è¦æ¥è‡ª `rewards` è¡¨ï¼Œè¯¥è¡¨å­˜å‚¨äº†æ¯å‘¨ç»“ç®—åçš„æ’åç»“æœã€‚

### æŸ¥è¯¢æ­¥éª¤

1. **è®¡ç®— weekNumber**
   ```typescript
   // å¦‚æœä¼ äº† week å’Œ year
   const weekNumber = year * 100 + week
   
   // å¦‚æœåªä¼ äº† weekï¼Œä½¿ç”¨å½“å‰å¹´ä»½
   const weekNumber = new Date().getFullYear() * 100 + week
   
   // å¦‚æœéƒ½æ²¡ä¼ ï¼ŒæŸ¥è¯¢å½“å‰å‘¨
   const weekNumber = getWeekNumber() // ä½¿ç”¨ lib/week.ts ä¸­çš„å‡½æ•°
   ```

2. **æŸ¥è¯¢è¯¥å‘¨çš„å¥–åŠ±è®°å½•**
   ```typescript
   const rewards = await db.rewards.findMany({
     where: { week_number: weekNumber },
     orderBy: { rank: 'asc' }, // æŒ‰æ’åå‡åº
     include: {
       users: {
         select: {
           id: true,
           nickname: true,
           avatar: true,
         }
       }
     }
   })
   ```

3. **è®¡ç®—å‡é‡ç™¾åˆ†æ¯”å’Œä¸Šå‘¨ä½“é‡**
   ```typescript
   // éœ€è¦æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æœ¬æ¬¡ä½“é‡å’Œä¸Šå‘¨ä½“é‡
   // ä» checkins è¡¨ä¸­æŸ¥è¯¢
   const currentCheckin = await db.checkins.findFirst({
     where: {
       user_id: userId,
       week_number: weekNumber,
     }
   })
   
   // æŸ¥è¯¢ä¸Šå‘¨æ‰“å¡è®°å½•ï¼ˆå¿…é¡»ä¸Šå‘¨æœ‰æ‰“å¡æ‰èƒ½å‚ä¸æ’åï¼‰
   const lastWeekNumber = weekNumber - 1
   
   const lastCheckin = await db.checkins.findFirst({
     where: {
       user_id: userId,
       week_number: lastWeekNumber,
     }
   })
   
   // è®¡ç®—ç™¾åˆ†æ¯”ï¼ˆå¦‚æœä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡ï¼‰
   const percentage = lastCheckin && currentCheckin
     ? ((Number(lastCheckin.weight) - Number(currentCheckin.weight)) / Number(lastCheckin.weight) * 100).toFixed(1)
     : 0
   
   // æ³¨æ„ï¼šrewards è¡¨ä¸­çš„ weight_diff å·²ç»æ˜¯ç»“ç®—æ—¶è®¡ç®—å¥½çš„ï¼Œè¿™é‡ŒæŸ¥è¯¢æ˜¯ä¸ºäº†æ˜¾ç¤ºè¯¦æƒ…
   // åªæœ‰ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·æ‰ä¼šå‡ºç°åœ¨ rewards è¡¨ä¸­
   ```

### ä¼˜åŒ–æŸ¥è¯¢ï¼ˆJOIN æŸ¥è¯¢ï¼‰

ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå¯ä»¥ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼š

```typescript
// 1. æŸ¥è¯¢è¯¥å‘¨çš„å¥–åŠ±è®°å½•ï¼ˆå·²åŒ…å« weight_diffï¼‰
const rewards = await db.rewards.findMany({
  where: { week_number: weekNumber },
  orderBy: { rank: 'asc' },
  include: {
    users: {
      select: {
        id: true,
        nickname: true,
        avatar: true,
      }
    }
  }
})

// 2. æ‰¹é‡æŸ¥è¯¢æœ¬æ¬¡æ‰“å¡è®°å½•
const userIds = rewards.map(r => r.user_id)
const currentCheckins = await db.checkins.findMany({
  where: {
    user_id: { in: userIds },
    week_number: weekNumber,
  }
})

// 3. æ‰¹é‡æŸ¥è¯¢ä¸Šå‘¨æ‰“å¡è®°å½•ï¼ˆç”¨äºæ˜¾ç¤ºè¯¦æƒ…ï¼‰
const lastWeekNumber = weekNumber - 1
const lastCheckins = await db.checkins.findMany({
  where: {
    user_id: { in: userIds },
    week_number: lastWeekNumber,
  }
})

// 4. åœ¨å†…å­˜ä¸­ç»„è£…æ•°æ®
const leaderboardData = rewards.map(reward => {
  const currentCheckin = currentCheckins.find(c => c.user_id === reward.user_id)
  const lastCheckin = lastCheckins.find(c => c.user_id === reward.user_id)
  
  return {
    rank: reward.rank,
    userId: reward.user_id,
    nickname: reward.users.nickname || `ç”¨æˆ·${reward.user_id}`,
    avatar: reward.users.avatar,
    weightDiff: Number(reward.weight_diff), // ä½¿ç”¨ rewards è¡¨ä¸­å·²è®¡ç®—å¥½çš„å€¼
    percentage: lastCheckin && currentCheckin
      ? ((Number(lastCheckin.weight) - Number(currentCheckin.weight)) / Number(lastCheckin.weight) * 100).toFixed(1)
      : '0.0',
    lastWeight: lastCheckin ? Number(lastCheckin.weight) : null,
    currentWeight: currentCheckin ? Number(currentCheckin.weight) : null,
  }
})
```

**æ³¨æ„**ï¼š
- `rewards` è¡¨ä¸­çš„ `weight_diff` å­—æ®µå·²ç»æ˜¯ç»“ç®—æ—¶è®¡ç®—å¥½çš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
- åªæœ‰ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·æ‰ä¼šå‡ºç°åœ¨ `rewards` è¡¨ä¸­
- æŸ¥è¯¢ `lastCheckin` å’Œ `currentCheckin` ä¸»è¦æ˜¯ä¸ºäº†æ˜¾ç¤ºè¯¦æƒ…ï¼ˆä¸Šå‘¨ä½“é‡ã€æœ¬å‘¨ä½“é‡ã€å‡é‡ç™¾åˆ†æ¯”ç­‰ï¼‰
- æŸ¥è¯¢é€»è¾‘ç®€å•ï¼Œæ€§èƒ½è‰¯å¥½

### ç©ºæ•°æ®å¤„ç†

- å¦‚æœ `rewards` è¡¨ä¸­æ²¡æœ‰è¯¥å‘¨çš„è®°å½•ï¼Œè¯´æ˜è¯¥å‘¨è¿˜æœªç»“ç®—
- å¯ä»¥æŸ¥è¯¢ `checkins` è¡¨ï¼Œå¦‚æœæœ‰æ‰“å¡è®°å½•ä½† `rewards` è¡¨æ²¡æœ‰ï¼Œè¯´æ˜è¿˜æœªç»“ç®—
- è¿”å› `settled: false`ï¼Œå‰ç«¯æ˜¾ç¤º"ç­‰å¾…ç»“ç®—"æç¤º

---

## ğŸ’» å‰ç«¯é¡µé¢å®ç°

### é¡µé¢ç»“æ„

```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuthStore } from '@/store/auth-store'
import { BottomNav } from '@/components/BottomNav'
import { Card } from '@/components/ui/card'
import { Select } from '@/components/ui/select'
import { Avatar, AvatarImage, AvatarFallback } from '@/components/ui/avatar'
import { Loading } from '@/components/Loading'
import { Crown, Medal, Trophy } from 'lucide-react' // å›¾æ ‡
```

### çŠ¶æ€ç®¡ç†

```typescript
interface LeaderboardData {
  week: number
  weekNumber: number
  year: number
  settled: boolean
  settledAt: string | null
  users: Array<{
    rank: number
    userId: number
    nickname: string
    avatar: string | null
    weightDiff: number
    percentage: number
    lastWeight: number
    currentWeight: number
  }>
}

const [data, setData] = useState<LeaderboardData | null>(null)
const [loading, setLoading] = useState(true)
const [selectedWeek, setSelectedWeek] = useState<number | null>(null) // null è¡¨ç¤ºå½“å‰å‘¨
const [selectedYear, setSelectedYear] = useState<number>(new Date().getFullYear())
```

### æ•°æ®è·å–

```typescript
const fetchLeaderboard = async (week?: number, year?: number) => {
  try {
    setLoading(true)
    const token = useAuthStore.getState().token
    if (!token) return

    const { createApiHeaders } = await import('@/lib/api-headers')
    const params = new URLSearchParams()
    if (week) params.append('week', week.toString())
    if (year) params.append('year', year.toString())

    const response = await fetch(`/api/leaderboard?${params.toString()}`, {
      headers: createApiHeaders(token),
    })
    const result = await response.json()
    
    if (result.code === 200) {
      setData(result.data)
    }
  } catch (error) {
    console.error('è·å–æ’è¡Œæ¦œå¤±è´¥:', error)
  } finally {
    setLoading(false)
  }
}

useEffect(() => {
  fetchLeaderboard(selectedWeek || undefined, selectedYear)
}, [selectedWeek, selectedYear])
```

### UI ç»„ä»¶ç»“æ„

```tsx
<div className="min-h-screen bg-white pb-20">
  {/* é¡¶éƒ¨å¯¼èˆªæ  */}
  <header>...</header>

  {/* ä¸»å†…å®¹åŒºåŸŸ */}
  <main>
    {/* å‘¨æœŸé€‰æ‹©å™¨ */}
    <Card>
      <Select
        value={selectedWeek?.toString() || 'current'}
        onValueChange={(value) => {
          if (value === 'current') {
            setSelectedWeek(null)
          } else {
            setSelectedWeek(parseInt(value))
          }
        }}
      >
        <option value="current">æœ¬å‘¨</option>
        {/* åŠ¨æ€ç”Ÿæˆå†å²å‘¨é€‰é¡¹ */}
      </Select>
    </Card>

    {/* ç»“ç®—æ—¶é—´æç¤º */}
    {data && (
      <Card>
        {data.settled ? (
          <p>ç»“ç®—æ—¶é—´ï¼š{new Date(data.settledAt).toLocaleString('zh-CN')}</p>
        ) : (
          <p>ç­‰å¾…ç»“ç®—ï¼ˆæ¯å‘¨ä¸€ 21:00 è‡ªåŠ¨ç»“ç®—ï¼‰</p>
        )}
      </Card>
    )}

    {/* Top 3 å±•ç¤º */}
    {data && data.users.slice(0, 3).map((user, index) => (
      <TopThreeCard key={user.userId} user={user} rank={index + 1} />
    ))}

    {/* Rank 4+ åˆ—è¡¨ */}
    {data && data.users.slice(3).map((user) => (
      <RankCard key={user.userId} user={user} />
    ))}

    {/* ç©ºçŠ¶æ€ */}
    {!loading && data && data.users.length === 0 && (
      <Card>
        <p className="text-center text-gray-500">æš‚æ— æ’è¡Œæ¦œæ•°æ®</p>
      </Card>
    )}

    {/* åº•éƒ¨è¯´æ˜ */}
    <Card>
      <p className="text-xs text-center text-gray-500">
        æ’åæ ¹æ®ï¼ˆä¸Šå‘¨ä½“é‡ - æœ¬å‘¨ä½“é‡ï¼‰è®¡ç®—ï¼Œå‡é‡è¶Šå¤šæ’åè¶Šé«˜ã€‚åªæœ‰ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·æ‰èƒ½å‚ä¸æ’åã€‚
      </p>
    </Card>
  </main>

  {/* åº•éƒ¨å¯¼èˆªæ  */}
  <BottomNav />
</div>
```

### Top 3 å¡ç‰‡ç»„ä»¶

```tsx
function TopThreeCard({ user, rank }: { user: LeaderboardData['users'][0], rank: number }) {
  const router = useRouter()
  
  const config = {
    1: {
      bg: 'from-yellow-50 to-yellow-100',
      badge: 'from-yellow-400 to-yellow-600',
      icon: Crown,
      title: 'å† å†›',
    },
    2: {
      bg: 'from-gray-50 to-gray-100',
      badge: 'from-gray-300 to-gray-500',
      icon: Medal,
      title: 'äºšå†›',
    },
    3: {
      bg: 'from-orange-50 to-orange-100',
      badge: 'from-orange-400 to-orange-600',
      icon: Medal,
      title: 'å­£å†›',
    },
  }[rank]

  const Icon = config.icon

  return (
    <Card className={`p-4 bg-gradient-to-br ${config.bg}`}>
      <div className="flex items-center gap-4">
        <div className={`w-12 h-12 bg-gradient-to-br ${config.badge} rounded-full flex items-center justify-center text-white font-bold text-lg`}>
          {rank}
        </div>
        <Avatar 
          className="w-12 h-12 cursor-pointer hover:opacity-80"
          onClick={() => router.push(`/profile/${user.userId}`)}
        >
          <AvatarImage src={user.avatar || undefined} />
          <AvatarFallback>{user.nickname[0] || 'ğŸ‘¤'}</AvatarFallback>
        </Avatar>
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <p 
              className="font-semibold text-gray-900 cursor-pointer hover:underline"
              onClick={() => router.push(`/profile/${user.userId}`)}
            >
              {user.nickname || `ç”¨æˆ·${user.userId}`}
            </p>
            <Icon className="w-4 h-4 text-yellow-600" />
          </div>
          <p className="text-sm text-gray-600">
            å‡é‡ {user.weightDiff.toFixed(1)} kg ({user.percentage}%)
          </p>
        </div>
      </div>
    </Card>
  )
}
```

### Rank 4+ å¡ç‰‡ç»„ä»¶

```tsx
function RankCard({ user }: { user: LeaderboardData['users'][0] }) {
  const router = useRouter()

  return (
    <div
      className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors"
      onClick={() => router.push(`/profile/${user.userId}`)}
    >
      <div className="w-8 h-8 flex items-center justify-center text-gray-500 font-medium">
        {user.rank}
      </div>
      <Avatar className="w-10 h-10">
        <AvatarImage src={user.avatar || undefined} />
        <AvatarFallback>{user.nickname[0] || 'ğŸ‘¤'}</AvatarFallback>
      </Avatar>
      <div className="flex-1">
        <p className="text-sm font-medium text-gray-900 hover:underline">
          {user.nickname || `ç”¨æˆ·${user.userId}`}
        </p>
        <p className="text-xs text-gray-500">
          å‡é‡ {user.weightDiff.toFixed(1)} kg
        </p>
      </div>
    </div>
  )
}
```

---

## ğŸ“Š æ’åè®¡ç®—é€»è¾‘

### æ’åè§„åˆ™

1. **å‚ä¸æ’åæ¡ä»¶**ï¼š
   - **å¿…é¡»ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡**ï¼šåªæœ‰åŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„ç”¨æˆ·æ‰èƒ½å‚ä¸æ’å
   - å¦‚æœç”¨æˆ·ä¸Šå‘¨æ²¡æ‰“å¡ï¼Œå³ä½¿æœ¬å‘¨æ‰“å¡äº†ï¼Œä¹Ÿä¸èƒ½å‚ä¸æ’å
   - å¦‚æœç”¨æˆ·æœ¬å‘¨æ²¡æ‰“å¡ï¼Œä¸èƒ½å‚ä¸æ’å

2. **å‡é‡å·®å€¼è®¡ç®—**ï¼š
   ```
   weightDiff = ä¸Šå‘¨ä½“é‡ - æœ¬å‘¨ä½“é‡
   ```
   
   - å¦‚æœ `weightDiff > 0`ï¼šå‡é‡
   - å¦‚æœ `weightDiff < 0`ï¼šå¢é‡
   - å¦‚æœ `weightDiff = 0`ï¼šä½“é‡ä¸å˜

3. **æ’åè§„åˆ™**ï¼š
   - æŒ‰ `weightDiff` **é™åº**æ’åˆ—ï¼ˆå‡é‡è¶Šå¤šæ’åè¶Šé«˜ï¼‰
   - å¦‚æœ `weightDiff` ç›¸åŒï¼ŒæŒ‰æ‰“å¡æ—¶é—´**å‡åº**æ’åˆ—ï¼ˆå…ˆæ‰“å¡çš„æ’åé å‰ï¼‰

4. **å¥–åŠ±ç±»å‹**ï¼š
   - `rank = 1`ï¼šå† å†›ï¼ˆtype = 1ï¼‰
   - `rank = 2`ï¼šäºšå†›ï¼ˆtype = 2ï¼‰
   - `rank = 3`ï¼šå­£å†›ï¼ˆtype = 3ï¼‰
   - `rank >= 4`ï¼šå‚ä¸å¥–ï¼ˆtype = 4ï¼‰

### ç‰¹æ®Šæƒ…å†µå¤„ç†

1. **é¦–æ¬¡æ‰“å¡ç”¨æˆ·**ï¼š
   - å¦‚æœç”¨æˆ·æ˜¯é¦–æ¬¡æ‰“å¡ï¼ˆæ²¡æœ‰ä¸Šå‘¨æ‰“å¡è®°å½•ï¼‰ï¼Œ**ä¸èƒ½å‚ä¸æ’å**
   - ä¸ä¼šå‡ºç°åœ¨æ’è¡Œæ¦œä¸­

2. **ä¸Šå‘¨æœªæ‰“å¡çš„ç”¨æˆ·**ï¼š
   - **å¤„ç†æ–¹å¼**ï¼š**ä¸èƒ½å‚ä¸æ’å**
   - å³ä½¿æœ¬å‘¨æœ‰æ‰“å¡ï¼Œä¹Ÿä¸ä¼šå‡ºç°åœ¨æ’è¡Œæ¦œä¸­
   - **åŸå› **ï¼šç¡®ä¿æ’åçš„å…¬å¹³æ€§ï¼Œåªæœ‰è¿ç»­æ‰“å¡çš„ç”¨æˆ·æ‰èƒ½å‚ä¸æ’å

3. **æœ¬å‘¨æœªæ‰“å¡çš„ç”¨æˆ·**ï¼š
   - **å¤„ç†æ–¹å¼**ï¼š**ä¸èƒ½å‚ä¸æ’å**
   - ä¸ä¼šå‡ºç°åœ¨æ’è¡Œæ¦œä¸­

4. **å¢é‡ç”¨æˆ·**ï¼š
   - å¦‚æœä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡ï¼Œå³ä½¿ `weightDiff < 0`ï¼ˆå¢é‡ï¼‰ï¼Œä»ç„¶å¯ä»¥å‚ä¸æ’å
   - æ’åä¼šé åï¼Œä½†ä»ç„¶å¯ä»¥è·å¾—å‚ä¸å¥–

5. **ç›¸åŒå‡é‡å€¼**ï¼š
   - å¦‚æœå¤šä¸ªç”¨æˆ·çš„ `weightDiff` ç›¸åŒï¼ŒæŒ‰æ‰“å¡æ—¶é—´æ’åº
   - å…ˆæ‰“å¡çš„æ’åé å‰

### ç»“ç®—æ—¶çš„è®¡ç®—é€»è¾‘ï¼ˆä¼ªä»£ç ï¼‰

```typescript
// ç»“ç®—æ—¶è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„ weightDiff
async function calculateWeightDiff(userId: number, currentWeekNumber: number) {
  // 1. è·å–æœ¬å‘¨æ‰“å¡è®°å½•
  const currentCheckin = await db.checkins.findFirst({
    where: {
      user_id: userId,
      week_number: currentWeekNumber,
    }
  })
  
  if (!currentCheckin) {
    return null // è¯¥ç”¨æˆ·æœ¬å‘¨æœªæ‰“å¡ï¼Œä¸å‚ä¸æ’å
  }
  
  // 2. è·å–ä¸Šå‘¨æ‰“å¡è®°å½•ï¼ˆå¿…é¡»ä¸Šå‘¨æœ‰æ‰“å¡æ‰èƒ½å‚ä¸æ’åï¼‰
  const lastWeekNumber = currentWeekNumber - 1
  
  const lastCheckin = await db.checkins.findFirst({
    where: {
      user_id: userId,
      week_number: lastWeekNumber,
    }
  })
  
  // 3. å¦‚æœä¸Šå‘¨æ²¡æœ‰æ‰“å¡ï¼Œä¸èƒ½å‚ä¸æ’å
  if (!lastCheckin) {
    return null // è¯¥ç”¨æˆ·ä¸Šå‘¨æœªæ‰“å¡ï¼Œä¸å‚ä¸æ’å
  }
  
  // 4. è®¡ç®—å‡é‡å·®å€¼
  const weightDiff = Number(lastCheckin.weight) - Number(currentCheckin.weight)
  
  return {
    weightDiff,
    lastWeight: Number(lastCheckin.weight),
    currentWeight: Number(currentCheckin.weight),
  }
}

// ç»“ç®—æ•´ä¸ªå‘¨çš„æ’å
async function settleWeekRanking(weekNumber: number, force: boolean = false) {
  // 0. æ£€æŸ¥æ˜¯å¦å·²ç»ç»“ç®—è¿‡ï¼ˆé™¤éå¼ºåˆ¶é‡æ–°ç»“ç®—ï¼‰
  if (!force) {
    const existingRewards = await db.rewards.findFirst({
      where: { week_number: weekNumber },
    })
    
    if (existingRewards) {
      const count = await db.rewards.count({
        where: { week_number: weekNumber },
      })
      return { 
        success: false, 
        message: 'è¯¥å‘¨å·²ç»ç»“ç®—è¿‡',
        alreadySettled: true,
        count 
      }
    }
  } else {
    // å¼ºåˆ¶é‡æ–°ç»“ç®—ï¼šå…ˆåˆ é™¤æ—§çš„ç»“ç®—è®°å½•
    await db.rewards.deleteMany({
      where: { week_number: weekNumber },
    })
  }
  
  // 1. è·å–æœ¬å‘¨æ‰€æœ‰æ‰“å¡è®°å½•
  const currentCheckins = await db.checkins.findMany({
    where: { week_number: weekNumber },
  })
  
  if (currentCheckins.length === 0) {
    return { 
      success: false, 
      message: 'è¯¥å‘¨æ²¡æœ‰æ‰“å¡è®°å½•',
      count: 0 
    }
  }
  
  // 2. è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„ weightDiffï¼ˆåªè®¡ç®—ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·ï¼‰
  const lastWeekNumber = weekNumber - 1
  const lastCheckins = await db.checkins.findMany({
    where: { week_number: lastWeekNumber },
  })
  
  // 3. åˆ›å»ºä¸Šå‘¨æ‰“å¡ç”¨æˆ·çš„ Mapï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰
  const lastCheckinMap = new Map(
    lastCheckins.map(c => [c.user_id.toString(), c])
  )
  
  // 4. ç­›é€‰å‡ºä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·
  const eligibleUsers = currentCheckins
    .filter(current => lastCheckinMap.has(current.user_id.toString()))
    .map(current => {
      const last = lastCheckinMap.get(current.user_id.toString())!
      return {
        userId: current.user_id,
        weightDiff: Number(last.weight) - Number(current.weight),
        currentWeight: Number(current.weight),
        lastWeight: Number(last.weight),
        checkinTime: current.created_at,
      }
    })
  
  if (eligibleUsers.length === 0) {
    return { 
      success: false, 
      message: 'è¯¥å‘¨æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·ï¼ˆä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡ï¼‰',
      count: 0 
    }
  }
  
  // 5. æŒ‰ weightDiff é™åºæ’åºï¼Œå¦‚æœç›¸åŒåˆ™æŒ‰æ‰“å¡æ—¶é—´å‡åºæ’åº
  eligibleUsers.sort((a, b) => {
    if (b.weightDiff !== a.weightDiff) {
      return b.weightDiff - a.weightDiff // é™åº
    }
    return a.checkinTime.getTime() - b.checkinTime.getTime() // å‡åº
  })
  
  // 6. åˆ†é…æ’åå¹¶ä¿å­˜åˆ° rewards è¡¨
  const rewards = []
  for (let i = 0; i < eligibleUsers.length; i++) {
    const user = eligibleUsers[i]
    const rank = i + 1
    const type = rank <= 3 ? rank : 4 // 1=å† å†›ï¼Œ2=äºšå†›ï¼Œ3=å­£å†›ï¼Œ4=å‚ä¸å¥–
    
    const reward = await db.rewards.create({
      data: {
        user_id: user.userId,
        week_number: weekNumber,
        weight_diff: user.weightDiff,
        rank: rank,
        type: type,
        // certificate_url ä¼šåœ¨ç”Ÿæˆå¥–çŠ¶åæ›´æ–°
      },
    })
    
    rewards.push(reward)
  }
  
  return { 
    success: true, 
    message: 'ç»“ç®—æˆåŠŸ',
    count: rewards.length 
  }
}

// æ‰¹é‡è¡¥ç»“ç®—å¤šä¸ªå‘¨
async function settleMultipleWeeks(weekNumbers: number[], force: boolean = false) {
  const results = []
  
  for (const weekNumber of weekNumbers) {
    try {
      const result = await settleWeekRanking(weekNumber, force)
      results.push({
        weekNumber,
        ...result,
      })
    } catch (error: any) {
      results.push({
        weekNumber,
        success: false,
        message: error.message || 'ç»“ç®—å¤±è´¥',
        error: error.toString(),
      })
    }
  }
  
  return results
}
```

### ç»“ç®—é€»è¾‘ï¼ˆåç«¯å®ç°ï¼‰

æ’è¡Œæ¦œæ•°æ®æ˜¯åœ¨æ¯å‘¨ä¸€ 21:00 ç»“ç®—æ—¶ç”Ÿæˆçš„ï¼Œä¿å­˜åœ¨ `rewards` è¡¨ä¸­ã€‚å‰ç«¯åªéœ€è¦æŸ¥è¯¢ `rewards` è¡¨å³å¯ï¼Œä¸éœ€è¦å®æ—¶è®¡ç®—æ’åã€‚

### è¡¥ç»“ç®—åŠŸèƒ½

**æ”¯æŒè¡¥ç»“ç®—å†å²å‘¨**ï¼šå¦‚æœå‰å‡ å‘¨æœ‰æ‰“å¡æ•°æ®ä½†æ²¡æœ‰ç»“ç®—ï¼Œå¯ä»¥é€šè¿‡ API æ¥å£æ‰‹åŠ¨è¡¥ç»“ç®—ã€‚

#### è¡¥ç»“ç®—åœºæ™¯

1. **å†å²æ•°æ®è¡¥ç»“ç®—**ï¼š
   - ç³»ç»Ÿä¸Šçº¿å‰å·²æœ‰æ‰“å¡æ•°æ®
   - æŸå‘¨å®šæ—¶ä»»åŠ¡å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨è¡¥ç»“ç®—
   - æ•°æ®ä¿®å¤åéœ€è¦é‡æ–°ç»“ç®—

2. **é‡æ–°ç»“ç®—**ï¼š
   - å¦‚æœå‘ç°ç»“ç®—æ•°æ®æœ‰é—®é¢˜ï¼Œå¯ä»¥å¼ºåˆ¶é‡æ–°ç»“ç®—ï¼ˆä¼šåˆ é™¤æ—§æ•°æ®ï¼‰

#### è¡¥ç»“ç®— API æ¥å£

**è·¯å¾„**ï¼š`POST /api/admin/settle`

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| week | number | å¦ | å‘¨æ•°ï¼ˆ1-53ï¼‰ï¼Œä¸ä¼ åˆ™ç»“ç®—å½“å‰å‘¨ |
| year | number | å¦ | å¹´ä»½ï¼ˆå¦‚ 2025ï¼‰ï¼Œä¸ä¼ åˆ™ä½¿ç”¨å½“å‰å¹´ä»½ |
| force | boolean | å¦ | æ˜¯å¦å¼ºåˆ¶é‡æ–°ç»“ç®—ï¼ˆé»˜è®¤ falseï¼‰ï¼Œå¦‚æœä¸º true ä¼šåˆ é™¤æ—§æ•°æ®é‡æ–°ç»“ç®— |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```bash
# ç»“ç®—å½“å‰å‘¨
POST /api/admin/settle

# ç»“ç®—æŒ‡å®šå‘¨ï¼ˆ2025å¹´ç¬¬50å‘¨ï¼‰
POST /api/admin/settle?week=50&year=2025

# å¼ºåˆ¶é‡æ–°ç»“ç®—ï¼ˆåˆ é™¤æ—§æ•°æ®ï¼‰
POST /api/admin/settle?week=50&year=2025&force=true
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "msg": "ç»“ç®—æˆåŠŸ",
  "data": {
    "weekNumber": 202550,
    "count": 15
  }
}
```

**å¦‚æœå·²ç»“ç®—è¿‡**ï¼š

```json
{
  "code": 400,
  "msg": "è¯¥å‘¨å·²ç»ç»“ç®—è¿‡",
  "data": {
    "alreadySettled": true,
    "count": 15
  }
}
```

#### æ‰¹é‡è¡¥ç»“ç®—

å¦‚æœéœ€è¦æ‰¹é‡è¡¥ç»“ç®—å¤šä¸ªå‘¨ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ‰¹é‡æ¥å£ï¼š

**è·¯å¾„**ï¼š`POST /api/admin/settle/batch`

**è¯·æ±‚ä½“**ï¼š

```json
{
  "weeks": [
    { "week": 50, "year": 2025 },
    { "week": 51, "year": 2025 },
    { "week": 52, "year": 2025 }
  ],
  "force": false
}
```

**å“åº”**ï¼š

```json
{
  "code": 200,
  "msg": "æ‰¹é‡ç»“ç®—å®Œæˆ",
  "data": {
    "results": [
      {
        "weekNumber": 202550,
        "success": true,
        "message": "ç»“ç®—æˆåŠŸ",
        "count": 15
      },
      {
        "weekNumber": 202551,
        "success": false,
        "message": "è¯¥å‘¨å·²ç»ç»“ç®—è¿‡",
        "alreadySettled": true
      }
    ]
  }
}
```

#### è¡¥ç»“ç®—æ³¨æ„äº‹é¡¹

1. **å¹‚ç­‰æ€§**ï¼šå¦‚æœæŸå‘¨å·²ç»ç»“ç®—è¿‡ï¼Œå†æ¬¡è°ƒç”¨ä¼šè·³è¿‡ï¼ˆé™¤éä½¿ç”¨ `force=true`ï¼‰
2. **æ•°æ®å®Œæ•´æ€§**ï¼šè¡¥ç»“ç®—æ—¶åªè®¡ç®—ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·
3. **æ—¶é—´é¡ºåº**ï¼šå»ºè®®æŒ‰æ—¶é—´é¡ºåºè¡¥ç»“ç®—ï¼ˆä»æ—©åˆ°æ™šï¼‰ï¼Œå› ä¸ºç»“ç®—éœ€è¦ä¸Šå‘¨çš„æ•°æ®
4. **æƒé™æ§åˆ¶**ï¼šå»ºè®®æ·»åŠ ç®¡ç†å‘˜æƒé™éªŒè¯ï¼Œé¿å…è¯¯æ“ä½œ

---

## ğŸš€ å®ç°æ­¥éª¤

### é˜¶æ®µ 1ï¼šAPI æ¥å£å®ç°

1. **åˆ›å»ºæ’è¡Œæ¦œæŸ¥è¯¢ API**
   - åˆ›å»º `app/api/leaderboard/route.ts`
   - å®ç°æŸ¥è¯¢é€»è¾‘ï¼š
     - è§£æè¯·æ±‚å‚æ•°ï¼ˆweek, yearï¼‰
     - è®¡ç®— weekNumber
     - æŸ¥è¯¢ rewards è¡¨
     - å…³è”æŸ¥è¯¢ users è¡¨è·å–ç”¨æˆ·ä¿¡æ¯
     - æŸ¥è¯¢ checkins è¡¨è·å–ä½“é‡æ•°æ®
     - è®¡ç®—å‡é‡ç™¾åˆ†æ¯”
     - ç»„è£…è¿”å›æ•°æ®
   - é”™è¯¯å¤„ç†ï¼š
     - æœªç™»å½•ï¼šè¿”å› 401
     - æ•°æ®ä¸å­˜åœ¨ï¼šè¿”å› 404
     - æœåŠ¡å™¨é”™è¯¯ï¼šè¿”å› 500

2. **åˆ›å»ºç»“ç®—æœåŠ¡**
   - åˆ›å»º `lib/settlement.ts`
   - å®ç° `settleWeekRanking()` å‡½æ•°ï¼š
     - æ£€æŸ¥æ˜¯å¦å·²ç»“ç®—ï¼ˆå¹‚ç­‰æ€§ï¼‰
     - æŸ¥è¯¢æœ¬å‘¨å’Œä¸Šå‘¨æ‰“å¡è®°å½•
     - ç­›é€‰ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·
     - è®¡ç®—æ’åå¹¶ä¿å­˜åˆ° rewards è¡¨
   - å®ç° `settleMultipleWeeks()` å‡½æ•°ï¼ˆæ‰¹é‡è¡¥ç»“ç®—ï¼‰
   - å®ç° `startSettlementCron()` å‡½æ•°ï¼ˆå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼‰

3. **åˆ›å»ºç»“ç®— API æ¥å£**
   - åˆ›å»º `app/api/admin/settle/route.ts`
   - å®ç°å•ä¸ªå‘¨ç»“ç®—ï¼š
     - æ”¯æŒ `week` å’Œ `year` å‚æ•°
     - æ”¯æŒ `force` å‚æ•°ï¼ˆå¼ºåˆ¶é‡æ–°ç»“ç®—ï¼‰
     - è°ƒç”¨ `settleWeekRanking()` å‡½æ•°
   - å¯é€‰ï¼šåˆ›å»ºæ‰¹é‡ç»“ç®—æ¥å£ `app/api/admin/settle/batch/route.ts`

4. **å¯åŠ¨å®šæ—¶ä»»åŠ¡**
   - åœ¨ `app/layout.tsx` æˆ– `lib/init.ts` ä¸­å¯åŠ¨å®šæ—¶ä»»åŠ¡
   - ä½¿ç”¨ `node-cron` è®¾ç½®æ¯å‘¨ä¸€ 21:00 æ‰§è¡Œç»“ç®—

### é˜¶æ®µ 2ï¼šå‰ç«¯é¡µé¢å®ç°

1. **æ›´æ–°æ’è¡Œæ¦œé¡µé¢**
   - ä¿®æ”¹ `app/leaderboard/page.tsx`
   - æ·»åŠ çŠ¶æ€ç®¡ç†
   - å®ç°æ•°æ®è·å–é€»è¾‘

2. **å®ç°å‘¨æœŸé€‰æ‹©å™¨**
   - ä½¿ç”¨ Select ç»„ä»¶
   - åŠ¨æ€ç”Ÿæˆå†å²å‘¨é€‰é¡¹
   - å¤„ç†é€‰æ‹©å˜åŒ–äº‹ä»¶

3. **å®ç° Top 3 å±•ç¤º**
   - åˆ›å»º TopThreeCard ç»„ä»¶
   - å®ç°ä¸åŒæ’åçš„æ ·å¼
   - æ·»åŠ å›¾æ ‡å’Œå¾½ç« 

4. **å®ç° Rank 4+ åˆ—è¡¨**
   - åˆ›å»º RankCard ç»„ä»¶
   - å®ç°åˆ—è¡¨å±•ç¤º
   - æ·»åŠ ç‚¹å‡»è·³è½¬åŠŸèƒ½

5. **æ·»åŠ ç©ºçŠ¶æ€å’ŒåŠ è½½çŠ¶æ€**
   - æ˜¾ç¤º Loading ç»„ä»¶
   - æ˜¾ç¤ºç©ºæ•°æ®æç¤º

### é˜¶æ®µ 3ï¼šä¼˜åŒ–å’Œæµ‹è¯•

1. **æ€§èƒ½ä¼˜åŒ–**
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼ˆä½¿ç”¨ JOINï¼‰
   - æ·»åŠ ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

2. **UI ä¼˜åŒ–**
   - æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
   - ä¼˜åŒ–å“åº”å¼å¸ƒå±€
   - æ·»åŠ é”™è¯¯æç¤º

3. **æµ‹è¯•**
   - æµ‹è¯•ä¸åŒå‘¨çš„æ•°æ®æ˜¾ç¤º
   - æµ‹è¯•ç©ºæ•°æ®å¤„ç†
   - æµ‹è¯•ç”¨æˆ·äº¤äº’ï¼ˆç‚¹å‡»è·³è½¬ï¼‰

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‘¨æ•°è®¡ç®—**ï¼š
   - ä½¿ç”¨ `lib/week.ts` ä¸­çš„ `getWeekNumber()` å‡½æ•°
   - ç¡®ä¿å‘¨æ•°è®¡ç®—å‡†ç¡®

2. **æ—¶åŒºå¤„ç†**ï¼š
   - ç¡®ä¿æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ—¶åŒºä¸€è‡´
   - ä½¿ç”¨ UTC æ—¶é—´æˆ–ç»Ÿä¸€æ—¶åŒº

3. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - æ’è¡Œæ¦œæ•°æ®æ¥è‡ª `rewards` è¡¨ï¼ˆç»“ç®—åç”Ÿæˆï¼‰
   - å¦‚æœè¿˜æœªç»“ç®—ï¼Œå¯ä»¥æ˜¾ç¤º"ç­‰å¾…ç»“ç®—"æç¤º

4. **ç”¨æˆ·ä¿¡æ¯**ï¼š
   - å¦‚æœç”¨æˆ·æ²¡æœ‰æ˜µç§°ï¼Œæ˜¾ç¤º"ç”¨æˆ·{userId}"
   - å¦‚æœç”¨æˆ·æ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒæˆ–é¦–å­—æ¯

5. **æ’åæ˜¾ç¤º**ï¼š
   - Top 3 ä½¿ç”¨ç‰¹æ®Šæ ·å¼
   - Rank 4+ ä½¿ç”¨åˆ—è¡¨æ ·å¼
   - ç¡®ä¿æ’åæ•°å­—æ­£ç¡®æ˜¾ç¤º

6. **å‚ä¸æ’åçš„æ¡ä»¶**ï¼š
   - **é‡è¦**ï¼šåªæœ‰ä¸Šå‘¨å’Œæœ¬å‘¨éƒ½æœ‰æ‰“å¡çš„ç”¨æˆ·æ‰èƒ½å‚ä¸æ’å
   - å¦‚æœç”¨æˆ·ä¸Šå‘¨æ²¡æ‰“å¡ï¼Œå³ä½¿æœ¬å‘¨æ‰“å¡äº†ï¼Œä¹Ÿä¸èƒ½å‚ä¸æ’å
   - å¦‚æœç”¨æˆ·æœ¬å‘¨æ²¡æ‰“å¡ï¼Œä¸èƒ½å‚ä¸æ’å
   - é¦–æ¬¡æ‰“å¡çš„ç”¨æˆ·ï¼šä¸èƒ½å‚ä¸æ’åï¼ˆå› ä¸ºæ²¡æœ‰ä¸Šå‘¨æ‰“å¡è®°å½•ï¼‰
   - **è¿™æ ·è®¾è®¡çš„åŸå› **ï¼š
     - ç¡®ä¿æ’åçš„å…¬å¹³æ€§ï¼Œåªæœ‰è¿ç»­æ‰“å¡çš„ç”¨æˆ·æ‰èƒ½å‚ä¸æ’å
     - é¼“åŠ±ç”¨æˆ·æŒç»­å‚ä¸ï¼Œé¿å…æ–­æ–­ç»­ç»­æ‰“å¡
     - ç®€åŒ–æ’åè®¡ç®—é€»è¾‘ï¼Œé¿å…å¤æ‚çš„"æœ€è¿‘ä¸€æ¬¡æ‰“å¡"æŸ¥è¯¢

---

*æœ€åæ›´æ–°ï¼š2025å¹´12æœˆ*
